---
title: "Bird Project Final Analyses"
author: "Roi A.K."
date: "12/2/2020"
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    theme: journal
---


```{r loading packages,message=FALSE,warning=FALSE, echo=FALSE}


library(tidyverse) #Grammar for data manipulation
library(data.table) #more data manipulation tools
library(DataCombine) #Data manipulation grammar

library(WriteXLS) #writing excel
library(readxl) #reading excel

library(knitr) #markdown tools
library(kableExtra) #making pretty html tables

library(gridExtra) # allows plotting of multiple ggplots in one
library(grid) #same as above
library(colorRamps) # Colors for graphing
library(RColorBrewer) # Colors for graphing
library(scales) #Helps with visalization

library(mosaic) #Summary statistics
library(DescTools) #Summary statistics

library(effects) #Extracting model results
library(MuMIn) #Model results and interpretation
library(lme4) #mixed models
library(glmmTMB) #rsquared
library(merTools) #extracting results from mixed models
library(coefplot) #plotting coefficient plots
library(sjPlot) #visualizing and table output of models
library(arm) #model output visualization
library(rsq) #rsquared

library(naniar) # Visualization of missing values
library(Amelia) # Testing missing columns
#library(corrplot) #correlation plots
#library(psych) #correlation plots

library(leaps) #Information Criterion Test
library(rcompanion) #permutation tests
library(permute) #permutation tests
library(GmAMisc) #permutation t-tests
library(tadaatoolbox) #pretty t-test tables

library(vegan) #ordination, dissimilarity indices, and extrapolation tests
library(iNEXT) #similar to vegan
library(Matrix) #helping create dissimilarity matrices
library(SpadeR) #Diversity indices
library(fossil) #extrapolation functions for richness (jacknife, chao, etc.)
library(CircStats) #circular statistics tests
library(spatialEco) #Spatially explicit tests

```


```{r setup,warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#file path
path_files<- 'C:/Users/roiak/Documents/Ronen/Final/'

#sourcing functions and datasets
source("Ankori-Karlinsky_N.A_Birds_Functions.R")
source("Ankori-Karlinsky_N.A_Birds_Datasets.R")
#source("myplotbetadisp.R") # plotting function for NMDS (unused)

#Saving figures to file path as png
knitr::opts_chunk$set(
  dev = 'png',
  fig.path = (paste0(path_files,"/Final Figures/Final Results December 2020/")
)
)

```


## Introduction



##### Background and Main Questions

Here we present a comprehensive comparison of estimates of species richness obtained from Breeding Bird Survey (BBS) vs. Breeding Bird Atlas (BBA) data. 

Specifically, we ask two main questions:  

- **_1. Are estimates of regional richness (number of species at the scale of a large region such as state) obtained from the two sources of data similar?_**  
- **_2. If not, what are the reasons for the observed differences?_**  

Obtaining similar estimates of regional richness from the two sources may strengthen our confidence in the credibility of analyses based on these data. On the other hand, differences in estimates of regional richness may question the credibility of such analyses. Such comparisons may also help to identify current limitations and biases in BBS and/or BBA data, thereby providing possible ideas for improving the methods of data collection and/or analysis.

Elucidating the limitations and biases of these widely-used data can also strengthen our scientific understanding and interpretation of previous results obtained from these data sources, as well as shore up evidence-driven conservation efforts as birds in North America are increasingly threatened by human activities that lead to habitat loss and fragmentation.

##### Main Predictions 

We make 8 specific predictions:  

- **(1)** At the regional scale, BBA blocks sample a larger range of environmental conditions than BBS routes.  
- **(2)** At the local scale (the scale of the observational unit), BBA blocks are more heterogeneous in their environmental conditions than BBS routes.  
- **(3)** Estimates of regional richness based on BBA data would be higher than those based on BBS data.  
- **(4)** Much of the differences in regional richness between the two data sources would be accounted for by underlying differences in sample size (number of observation units).  
- **(5)** Estimates of regional richness based on BBA data would be higher than those based on BBS data also after controlling for underlying differences in the number of observations.  
- **(6)** Local richness in BBA blocks would be higher than that of BBS routes.  
- **(7)** Compositional turnover among BBS routes would be smaller than that among BBA blocks.  
- **(8)** Some of the variation in local richness among BBA blocks and BBS routes would be accounted for by underlying differences in sampling effort.

We tested these predictions by comparing the distribution of key environmental variables  

- elevation, precipitation, and temperature  

and estimates of species diversity  

- regional richness, local richness, and compositional turnover  

between BBS routes and BBA blocks in five states in Northeastern US:  

- Massachusetts (MA)  
- Michigan (MI)  
- New York (NY)  
- Pennsylvania (PA)  
- Vermont (VT)


##### Ad-hoc Analyses  

- **(1)** Regional richness estimates for BBS based on extrapolation analyses will still be lower than the observed regional richness in BBA  
- **(2)** A species' presence in BBA and absence in BBS will be explained either by its relative rareness or by its presence in a climatic habitat that isn't sampled by the BBS  
- **(3)** Higher local environmental heterogeneity will correlate with higher local species richness 
- **(4)** Geographic matching of pairs of BBA and BBS sampling units based on largest overlap (thereby controlling for sample size and geography) will still show higher compositional turnover for BBA blocks  
    + We run similarity analyses of environmental conditions within sampling units (land-class diversity, precipitation, elevation, and temperature)  
    + We use Bray-Curtis similarity for each variable  
    + We use Gower multivariate similarity to test all variables together  
- **(5)** BBA samples different environmental conditions due to geography  
    + Going to test whether the datasets sample different environmental conditions in terms of the distribution of each environmental variable.  
    + Testing differences in precipitation, temperature, and mean elevation using a Kolmogorov-Smirnov test with the ks.test() function from the dgof package.  
    + Then will run a PERMANOVA testing whether land-cover composition (shannon-wiener index) differs between BBA sites more so than between BBA sites using Bray-Curtis index (as in Ad-hoc test 4).  
    + Will run this the whole dataset and also for each state  
- **(6)** BBA blocks geographically matched to BBS routes with more than 30hrs sampling effort will have higher local richness.  
    + Based on a mixed model with local richness as response, dataset as fixed effect, and state as random effect (this is folded into Main Prediction 6)
- **(7)** To test state differences in local richness, we regressed mean difference in local richess between BBA and BBS sampling units against the mean difference in local effort for each state (this is folded into Main Prediction 8)  



**This document will run and output analyses results for each prediction in order, saving figures to file**

***

## Main Predictions


#### Prediction 1 

**At the regional scale, BBA blocks sample a larger range of environmental conditions than BBS routes**

This is tested with a paired t-test (n=5 states) by comparing differences in the the ranges of mean annual precipitation, mean summer temperature, and mean elevation, between BBA blocks and BBS routes.


```{r Prediction 1 Summary Tables,message=FALSE,warning=FALSE}

#First we create summary tables for analyses

#Summary table for ranges between datasets
Environmental_Range_Comparison <- full_d %>%
  filter(!is.na(Elev_Mean),
         !is.na(Temp),
         !is.na(Precipitation)) %>% #removing NAs
  group_by(Dataset,State) %>% # grouping by dataset,state
  dplyr::summarize(Precipitation_Range = max(Precipitation)-min(Precipitation), #precipitation
                   Temperature_Range = max(Temp)-min(Temp), #temperature
                   Elevation_Range = max(Elev_Mean)-min(Elev_Mean), #elevation
                   ) 

#Now summary table with adjacent blocks only
Adjacent_Environmental_Range_Comparison <- Adjacent_Full %>% 
    filter(!is.na(Elev_Mean),
         !is.na(Temp),
         !is.na(Precipitation)) %>% #removing NAs
  group_by(Dataset,State) %>% # grouping by dataset,state
  dplyr::summarize(Precipitation_Range = max(Precipitation)-min(Precipitation), #precipitation
                   Temperature_Range = max(Temp)-min(Temp), #temperature
                   Elevation_Range = max(Elev_Mean)-min(Elev_Mean), #elevation
                   ) 

#Now summary table with well sampled
Sampled_Environmental_Range_Comparison<- SampledFull %>% 
    filter(!is.na(Elev_Mean),
         !is.na(Temp),
         !is.na(Precipitation)) %>% #removing NAs
  group_by(Dataset,State) %>% # grouping by dataset,state
  dplyr::summarize(Precipitation_Range = max(Precipitation)-min(Precipitation), #precipitation
                   Temperature_Range = max(Temp)-min(Temp), #temperature
                   Elevation_Range = max(Elev_Mean)-min(Elev_Mean), #elevation
                   ) 

#Now summary table with info on both well sampled and adjacent blocks
Sampled_Adjacent_Environmental_Range_Comparison <- SampledAdj_Full %>% 
    filter(!is.na(Elev_Mean),
         !is.na(Temp),
         !is.na(Precipitation)) %>% #removing NAs
 group_by(Dataset,State) %>% # grouping by dataset,state
  dplyr::summarize(Precipitation_Range = max(Precipitation)-min(Precipitation), #precipitation
                   Temperature_Range = max(Temp)-min(Temp), #temperature
                   Elevation_Range = max(Elev_Mean)-min(Elev_Mean), #elevation
                   ) 

```



**Starting with entire dataset:**


```{r Prediction 1 T-Tests All Data,message=FALSE, warning=FALSE}
#For entire data Precipitation
tadaa_t.test(data=Environmental_Range_Comparison,
             response=Precipitation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#For entire data Temperature
tadaa_t.test(data=Environmental_Range_Comparison,
             response=Temperature_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#For entire data Elevation
tadaa_t.test(data=Environmental_Range_Comparison,
             response=Elevation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

```

---

**For adjacent blocks:**

```{r Prediction 1 T-Tests Adjacent,message=FALSE, warning=FALSE}
#Precipitation
tadaa_t.test(data=Adjacent_Environmental_Range_Comparison,
             response=Precipitation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#Temperature
tadaa_t.test(data=Adjacent_Environmental_Range_Comparison,
             response=Temperature_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#Elevation
tadaa_t.test(data=Adjacent_Environmental_Range_Comparison,
             response=Elevation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

```

---

**For well-sampled blocks (>30hr sampling):**

```{r Prediction 1 T-Tests Sampled,message=FALSE, warning=FALSE}
#Precipitation
tadaa_t.test(data=Sampled_Environmental_Range_Comparison,
             response=Precipitation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#Temperature
tadaa_t.test(data=Sampled_Environmental_Range_Comparison,
             response=Temperature_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#Elevation
tadaa_t.test(data=Sampled_Environmental_Range_Comparison,
             response=Elevation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

```

---

**For well-sampled adjacent blocks:**

```{r Prediction 1 T-Tests Sampled Adjacent,message=FALSE, warning=FALSE}
#Precipitation
tadaa_t.test(data=Sampled_Adjacent_Environmental_Range_Comparison,
             response=Precipitation_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#Temperature
tadaa_t.test(data=Sampled_Adjacent_Environmental_Range_Comparison,
             response=Temperature_Range,
             group=Dataset,
             paired=T,
             print="markdown")

#Elevation
tadaa_t.test(data=Sampled_Adjacent_Environmental_Range_Comparison,
             response=Elevation_Range,
             group=Dataset,
             paired=T,
             print="markdown")
```


```{r Prediction 1 Removing Items, message=FALSE, warning=FALSE}

#removing datasets from prediction 1 to save space in environment
rm(Environmental_Range_Comparison, Adjacent_Environmental_Range_Comparison,
   Sampled_Environmental_Range_Comparison,
   Sampled_Adjacent_Environmental_Range_Comparison)

```



---

#### Prediction 2

**At the local scale, BBA blocks are more heterogeneous in their environmental conditions than BBS routes**

Testing this by running a GLM with heterogeneity as response variable, dataset as fixed effect, and state as a random effect.

The model is run 3 times for each metric of heterogeneity:  
- Elevation range  
- Land-Class Richness (# of types in sampling unit)  
- Land-Class Diversity (Shannon-Wiener index based on relative abundances of land-class types)  

We also run the same analysis with geographically-matched pairs of sampling units based on the largest overlap in terms of area. This controls for geography and sample size.


**Starting with elevation range for entire dataset**

```{r Prediction 2 Elevation Range All data, message=FALSE, warning=FALSE}

#running model (assumed gaussian)
prediction2.elev <- glmer(Elev_Range ~ as.factor(Dataset)
                              + (1|State),
                              data=full_d)

#table output
tab_model(prediction2.elev,
          show.se=T)%>%
  return() %$% 
    knitr %>% 
    asis_output()

#extracting r2
r2=round(r.squaredGLMM(prediction2.elev)[2],digits=4)

#plot model
plot_model(prediction2.elev,type="pred",terms="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Elevation Range by Dataset",
       y="Elevation Range per Sampling Unit (m)")+
 geom_label(aes(x=1.5,y=250,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#plot random effect
plot_model(prediction2.elev,type="re",
           show.values = T,
           show.p=T)+
      scale_color_brewer(type = "qual",palette = 7)+
    theme_classic()+
  labs(title="Random Effect of State on Intercept")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 0,linetype="dotted")

#plot model with random effect
plot_model(prediction2.elev,type="pred",terms=c("State","Dataset"),
           show.values = T,
           pred.type="re",
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Elevation Range by Dataset",
       y="Elevation Range per Sampling Unit (m)")+
 geom_label(aes(x=1.5,y=250,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#removing from environment to save space
rm(prediction2.elev)

```




**Now Land-Class Richness for entire dataset**


```{r Prediction 2 Land-Class Richness Entire dataset, warning=FALSE, message=FALSE}
#running model (assumed gaussian)
prediction2.landrich <- glmer(Het_Count2006 ~ as.factor(Dataset)
                              +(1|State),
                              data=full_d)

#output model table
tab_model(prediction2.landrich,
          show.se=T) %>%
  return() %$% 
    knitr %>% 
    asis_output()

#extracting r2
r2=round(r.squaredGLMM(prediction2.landrich)[2],digits=4)


#plot model
plot_model(prediction2.landrich,type="pred",terms="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Richness by Dataset",
       y="# of Land Classes in Sampling Unit")+
  geom_label(aes(x=1.5,y=14,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#plot random effect of state
plot_model(prediction2.landrich,type="re",
           show.values = T,
           show.p=T)+
    theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Random Effect of State on Intercept")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_y_continuous(limits=c(-1.5,1.5))

#plotting random effect

plot_model(prediction2.landrich,type="pred",terms=c("State","Dataset"),
           group.terms = "Dataset",
           show.values = T,
           show.p=T,
           pred.type="re")+
  theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Richness by Dataset",
       y="# of Land Classes in Sampling Unit")+
  theme(plot.title=element_text(hjust=0.5))


#removing from environment to save space
rm(prediction2.landrich)

```





**Now Land-Class Diversity for entire dataset**


```{r Prediction 2 Land-Class Diversity Entire dataset, warning=FALSE, message=FALSE}
#running model (assumed gaussian)
prediction2.landdiv <- glmer(Shannon2006 ~ as.factor(Dataset)
                              + (1|State),
                              data=full_d)

#table
tab_model(prediction2.landdiv,
          show.se=T) %>%
  return() %$% 
    knitr %>% 
    asis_output()

#extracting r2
r2=round(r.squaredGLMM(prediction2.landdiv)[2],digits=4)


#plot model
plot_model(prediction2.landdiv,type="pred",terms="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Diversity by Dataset",
       y="Land-Class Diversity (Shannon-Wiener)")+
 geom_label(aes(x=1.5,y=1.8,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#plot random effect
plot_model(prediction2.landdiv,type="re",
           show.values = T,
           show.p=T)+
    theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Random Effect of State on Intercept")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 0,linetype="dotted")+
  scale_y_continuous(limits=c(-0.5,0.5))

#plot model with random effect
plot_model(prediction2.landdiv,type="pred",terms=c("State","Dataset"),
           pred.type="re",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Diversity by Dataset",
       y="Land-Class Diversity (Shannon-Wiener)")+
  theme(plot.title=element_text(hjust=0.5))

#removing from environment to save space
rm(prediction2.landdiv)

```


---


**Now running same analysis but for geographically-matched sampling units**

**Starting with elevation range for adjacent dataset**

```{r Prediction 2 Elevation Range adjacent data, message=FALSE, warning=FALSE}

#running model (assumed gaussian)
adj_prediction2.elev <- glmer(Elev_Range ~ as.factor(Dataset)
                              + (1|State),
                              data=Adjacent_Full)

#table output
tab_model(adj_prediction2.elev,
          show.se=T)%>%
  return() %$% 
    knitr %>% 
    asis_output()

#extracting r2
r2=round(r.squaredGLMM(adj_prediction2.elev)[2],digits=4)

#plot model
plot_model(adj_prediction2.elev,type="pred",terms="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Elevation Range by Dataset
       Matched Sampling Units",
       y="Elevation Range per Sampling Unit (m)")+
 geom_label(aes(x=1.5,y=250,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#plot random effect
plot_model(adj_prediction2.elev,type="re",
           show.values = T,
           show.p=T)+
      scale_color_brewer(type = "qual",palette = 7)+
    theme_classic()+
  labs(title="Random Effect of State on Intercept
       Matched Sampling Units")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 0,linetype="dotted")

#plot model with random effect
plot_model(adj_prediction2.elev,type="pred",terms=c("State","Dataset"),
           show.values = T,
           pred.type="re",
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Elevation Range by Dataset
       Matched Sampling Units",
       y="Elevation Range per Sampling Unit (m)")+
 geom_label(aes(x=1.5,y=250,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#removing from environment to save space
rm(adj_prediction2.elev)

```




**Now Land-Class Richness for adjacent dataset**


```{r Prediction 2 Land-Class Richness adjacent dataset, warning=FALSE, message=FALSE}
#running model (assumed gaussian)
adj_prediction2.landrich <- glmer(Het_Count2006 ~ as.factor(Dataset)
                              +(1|State),
                              data=Adjacent_Full)

#output model table
tab_model(adj_prediction2.landrich,
          show.se=T) %>%
  return() %$% 
    knitr %>% 
    asis_output()

#extracting r2
r2=round(r.squaredGLMM(adj_prediction2.landrich)[2],digits=4)


#plot model
plot_model(adj_prediction2.landrich,type="pred",terms="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Richness by Dataset
       Matched Sampling Units",
       y="# of Land Classes in Sampling Unit")+
  geom_label(aes(x=1.5,y=14,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#plot random effect of state
plot_model(adj_prediction2.landrich,type="re",
           show.values = T,
           show.p=T)+
    theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Random Effect of State on Intercept
       Matched Sampling Units")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_y_continuous(limits=c(-1.5,1.5))

#plotting random effect

plot_model(adj_prediction2.landrich,type="pred",terms=c("State","Dataset"),
           group.terms = "Dataset",
           show.values = T,
           show.p=T,
           pred.type="re")+
  theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Richness by Dataset
       Matched Sampling Units",
       y="# of Land Classes in Sampling Unit")+
  theme(plot.title=element_text(hjust=0.5))

#removing from environment to save space
rm(adj_prediction2.landrich)

```





**Now Land-Class Diversity for adjacent dataset**


```{r Prediction 2 Land-Class Diversity adjacent dataset, warning=FALSE, message=FALSE}
#running model (assumed gaussian)
adj_prediction2.landdiv <- glmer(Shannon2006 ~ as.factor(Dataset)
                              + (1|State),
                              data=Adjacent_Full)

#table
tab_model(adj_prediction2.landdiv,
          show.se=T) %>%
  return() %$% 
    knitr %>% 
    asis_output()

#extracting r2
r2=round(r.squaredGLMM(adj_prediction2.landdiv)[2],digits=4)


#plot model
plot_model(adj_prediction2.landdiv,type="pred",terms="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Diversity by Dataset
       Matched Sampling Units",
       y="Land-Class Diversity (Shannon-Wiener)")+
 geom_label(aes(x=1.5,y=1.8,
                 label=paste("R2=",r2)),col="black")+
  theme(plot.title=element_text(hjust=0.5))

#plot random effect
plot_model(adj_prediction2.landdiv,type="re",
           show.values = T,
           show.p=T)+
    theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Random Effect of State on Intercept
       Matched Sampling Units")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 0,linetype="dotted")+
  scale_y_continuous(limits=c(-0.5,0.5))

#plot model with random effect
plot_model(adj_prediction2.landdiv,type="pred",terms=c("State","Dataset"),
           pred.type="re",
           show.values = T,
           show.p=T)+theme_classic()+
      scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Land-Class Diversity by Dataset
       Matched Sampling Units",
       y="Land-Class Diversity (Shannon-Wiener)")+
  theme(plot.title=element_text(hjust=0.5))

#removing from environment to save space
rm(adj_prediction2.landdiv)

```



---

#### Prediction 3

**Estimates of regional richness based on BBA data would be higher than those based on BBS data**

We use a pairwise t-test (n = 5 states) to determine the significance of the observed difference.

Similarly to Prediction 1 (see above), we test this on the entire BBA dataset, as well as geographically matched data and well sampled data

```{r Prediction 3 Summary Tables,message=FALSE,warning=FALSE}

#Summary table for state regional richness
Richness_Comparison <- tidy_full %>%
  filter(Observations=="1") %>% # keeping only observations of birds 
  group_by(Dataset,State) %>% # grouping by dataset,state
  dplyr::summarize(Regional_Richness = n_distinct(Species)) # counting only unique observations per species

#Now summary table with adjacent
Adjacent_Richness_Comparison <- tidy_full %>% 
  filter(Observations=="1",BBS_Adjacent!="No"|is.na(BBS_Adjacent)) %>% # keeping only observations of birds  that are adjacent
  group_by(Dataset,State) %>% # grouping by dataset,state,
  dplyr::summarize(Regional_Richness = n_distinct(Species)) # counting only unique observations per species

#Now summary table with well sampled
Sampled_Richness_Comparison <- tidy_full %>% 
  filter(Observations=="1",!is.na(Atlas2_Effort),Well_Sampled!="No"|is.na(Well_Sampled)) %>% # keeping only observations of birds with hour info that are well sampled
  group_by(Dataset,State) %>% # grouping by dataset,state, 
  dplyr::summarize(Regional_Richness = n_distinct(Species))

#Now summary table with info on both well sampled and adjacent blocks
Sampled_Adjacent_Richness_Comparison <- tidy_full %>% 
  filter(Observations=="1",!is.na(Atlas2_Effort),
         Well_Sampled!="No"|is.na(Well_Sampled),
         BBS_Adjacent!="No"|is.na(BBS_Adjacent)) %>% # keeping only observations of birds with hour info that are well sampled and adjacent
  group_by(Dataset,State) %>% # grouping by dataset,state, 
  dplyr::summarize(Regional_Richness = n_distinct(Species))

```



**Starting with entire dataset:**


```{r Prediction 3 T-Tests All Data,message=FALSE, warning=FALSE}
 
tadaa_t.test(data=Richness_Comparison,
             response=Regional_Richness,
             group=Dataset,
             paired=T,
             print="markdown")

```



**For adjacent blocks:**

```{r Prediction 3 T-Tests Adjacent,message=FALSE, warning=FALSE}

tadaa_t.test(data=Adjacent_Richness_Comparison,
             response=Regional_Richness,
             group=Dataset,
             paired=T,
             print="markdown")

```


**For well-sampled blocks (>30hr sampling):**

```{r Prediction 3 T-Tests Sampled,message=FALSE, warning=FALSE}

tadaa_t.test(data=Sampled_Richness_Comparison,
             response=Regional_Richness,
             group=Dataset,
             paired=T,
             print="markdown")

```


**For well-sampled adjacent blocks:**

```{r Prediction 3 T-Tests Sampled Adjacent,message=FALSE, warning=FALSE}
tadaa_t.test(data=Sampled_Adjacent_Richness_Comparison,
             response=Regional_Richness,
             group=Dataset,
             paired=T,
             print="markdown")
```


```{r Prediction 3 Removing Items, message=FALSE, warning=FALSE}

#removing prediction 3 datasets to save memory space
rm(Richness_Comparison,Adjacent_Richness_Comparison,
   Sampled_Richness_Comparison, Sampled_Adjacent_Richness_Comparison)

```


---


#### Prediction 4

**Much of the difference in regional richness between the two data sources would be accounted for by underlying differences in sample size**  

We test this using Monte Carlo simulations. Such simulations are used to estimate the number of species (S) in a random sample of n BBA blocks, where n is the number of BBS routes within the relevant area. 

We define $S^{BBA}_{n}$ as the number of species in a random sample of n BBA blocks and $S^{BBA}_{all}$ as the total number of species in all BBA blocks within the relevant area.

We take the difference between $S^{BBA}_{all}$ and the mean value of $S^{BBA}_{n}$ in 1,000 random samples (with replacement) of n BBA blocks to be the contribution of the difference in sample size to the observed difference in regional richness between the BBA and BBS data.


**Calculating Proportion of Simluation Equal to Observed Regional Richness**

```{r Prediction 4 BBA compared to MC,message=FALSE,warning=FALSE}

#Running simulation
region.test<-BirdRandProp(BBA,BBS) #running simulation

#output table
tally(~region.test$nrow<274,format="prop")

#For MA
ma.test<-BirdRandProp(MABBA,MABBS)
tally(~ma.test$nrow<220,format="prop")

#For MI
mi.test<-BirdRandProp(MIBBA,MIBBS)
tally(~mi.test$nrow<235,format="prop")

#For NY
ny.test<-BirdRandProp(NYBBA,NYBBS)
tally(~ny.test$nrow<247,format="prop")

#For PA
pa.test<-BirdRandProp(PABBA,PABBS)
tally(~pa.test$nrow<202,format="prop")

#For VT
vt.test<-BirdRandProp(VTBBA,VTBBS)
tally(~vt.test$nrow<192,format="prop")

```



**Running the same analysis on geographically-matched sampling units**

```{r Prediction 4 Adj compared to Adjacent MC,message=FALSE,warning=FALSE}

#Running simulation
adj.region.test<-BirdRandProp(Adj,BBS) #running simulation

#output table
tally(~adj.region.test$nrow<252,format="prop")

#For MA
adj.ma.test<-BirdRandProp(MA_BBA_Adj,MABBS)
tally(~adj.ma.test$nrow<178,format="prop")

#For MI
adj.mi.test<-BirdRandProp(MI_BBA_Adj,MIBBS)
tally(~adj.mi.test$nrow<216,format="prop")

#For NY
adj.ny.test<-BirdRandProp(NY_BBA_Adj,NYBBS)
tally(~adj.ny.test$nrow<233,format="prop")

#For PA
adj.pa.test<-BirdRandProp(PA_BBA_Adj,PABBS)
tally(~adj.pa.test$nrow<182,format="prop")

#For VT
adj.vt.test<-BirdRandProp(VT_BBA_Adj,VTBBS)
tally(~adj.vt.test$nrow<157,format="prop")

```



**Outputting table of regional richness estimates with MC simulation**

```{r Prediction 4 - Table,message=FALSE,warning=FALSE}
#Region column
Region <- c("All","MA","MI","NY","PA","VT")

#Estimate mean regional richness based on 1000 runs when n=BBS 
`MC Regional Richness` <- c(BirdRand(BBA,BBS)[1,],
                        BirdRand(MABBA,MABBS)[1,],
                        BirdRand(MIBBA,MIBBS)[1,],
                        BirdRand(NYBBA,NYBBS)[1,],
                        BirdRand(PABBA,PABBS)[1,],
                        BirdRand(VTBBA,VTBBS)[1,])

#Observed regional richness in BBA
`BBA Regional Richness` <-c(274,220,235,247,202,192)

#Adding difference column
`Sample_Size_Contribution` <- `BBA Regional Richness`-`MC Regional Richness`

#Creating dataframe
Sample_Size_Comparison <- data.frame(Region,
                                     `BBA Regional Richness`,
                                     `MC Regional Richness`,
                                     `Sample_Size_Contribution`)

#Outputting table with results
kable(Sample_Size_Comparison,
      caption = "Regional Richness Comparison",
      booktabs=T) %>%
  kable_styling(position = "left",
                full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  row_spec(0,color="black")

```






**Outputting table of regional richness estimates with MC simulation**

```{r Prediction 4 - Table for Adjacent ,message=FALSE,warning=FALSE}

#Estimate mean regional richness based on 1000 runs when n=BBS 
`MC Adjacent Regional Richness` <- c(BirdRand(Adj,BBS)[1,],
                        BirdRand(MA_BBA_Adj,MABBS)[1,],
                        BirdRand(MI_BBA_Adj,MIBBS)[1,],
                        BirdRand(NY_BBA_Adj,NYBBS)[1,],
                        BirdRand(PA_BBA_Adj,PABBS)[1,],
                        BirdRand(VT_BBA_Adj,VTBBS)[1,])

#Observed regional richness in BBA
`Adjacent Regional Richness` <-c(251,178,216,233,182,157)

#Adding difference column

`Adjacent_Sample_Size_Contribution` <- `Adjacent Regional Richness`-`MC Adjacent Regional Richness`


#Creating dataframe
Sample_Size_Comparison_Adjacent <- data.frame(Region,
                                     `Adjacent Regional Richness`,
                                     `MC Adjacent Regional Richness`,
                                     `Adjacent_Sample_Size_Contribution`)

#Outputting table with results
kable(Sample_Size_Comparison_Adjacent,
      caption = "Regional Richness Comparison for Adjacent Blocks",
      booktabs=T) %>%
  kable_styling(position = "left",
                full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  row_spec(0,color="black")

```

**We see clearly that sample size is a large effect**


---

#### Prediction 5

**Estimates of regional richness based on BBA data would be higher than those based on BBS data also after controlling for underlying differences in the number of observations**

This is tested by comparing the mean number of species in 1,000 random samples (with replacement) of n BBA blocks ($S_{n}^{BBA}$) with the number of species in the n BBS routes ($S_{n}^{BBS}$). 

The statistical significance of the difference is determined as the fraction of BBA samples with 
$$S_{n}^{BBA} < S_{n}^{BBS}$$

**Testing proportion of simulation with bigger than BBS estimates per region**

```{r Prediction 5 BBS compared to MC,message=FALSE,warning=FALSE}

#entire region
tally(~region.test$nrow>213,format="prop")

#For MA
tally(~ma.test$nrow>143,format="prop")

#For MI
tally(~mi.test$nrow>189,format="prop")

#For NY
tally(~ny.test$nrow>184,format="prop")

#For PA
tally(~pa.test$nrow>158,format="prop")

#For VT
tally(~vt.test$nrow>143,format="prop")

```



**Running the same analysis on geographically-matched sampling units**

```{r Prediction 5 BBS compared to Adjacent MC,message=FALSE,warning=FALSE}

#adjacent entire region
tally(~adj.region.test$nrow>213,format="prop")

#For MA
tally(~adj.ma.test$nrow>143,format="prop")

#For MI
tally(~adj.mi.test$nrow>189,format="prop")

#For NY
tally(~adj.ny.test$nrow>184,format="prop")

#For PA
tally(~adj.pa.test$nrow>158,format="prop")

#For VT
tally(~adj.vt.test$nrow>143,format="prop")

```


**Outputting Comparison Tables to BBS**

```{r Prediction 5 - Table,message=FALSE,warning=FALSE}

#Observed regional richness in BBS
`BBS Regional Richness` <-c(213,143,189,184,158,143)

#Adding difference column
`Sample_Size_Effect` <- `MC Regional Richness`-`BBS Regional Richness`

#Creating dataframe
Sample_Size_Test <- data.frame(Region,
                               `MC Regional Richness`,
                               `BBS Regional Richness`,
                               `Sample_Size_Effect`)

#Outputting table with results
kable(Sample_Size_Test,
      caption = "Sample Size Effect on Regional Richness",
      booktabs=T) %>%
  kable_styling(position = "left",
                full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  row_spec(0,color="black")

```






**Outputting table of regional richness estimates with MC simulation**

```{r Prediction 5 - Table for Adjacent ,message=FALSE,warning=FALSE}

#Adding difference column
`Sample_Size_Effect_Adjacent` <- `MC Adjacent Regional Richness`-`BBS Regional Richness`

#Creating dataframe
Sample_Size_Test_Adjacent <- data.frame(Region,
                                     `MC Adjacent Regional Richness`,
                                     `BBS Regional Richness`,
                                     `Sample_Size_Effect_Adjacent`)

#Outputting table with results
kable(Sample_Size_Test_Adjacent,
      caption = "Sample Size Effect on Regional Richness Adjacent Blocks",
      booktabs=T) %>%
  kable_styling(position = "left",
                full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  row_spec(0,color="black")

```




**Outputting table of % richness difference explained by sample size**

This is calculated as:

$\frac{BBA_{Regional} - MC_{Regional}} {BBA_{Regional} - BBS_{Regional}}$



```{r Prediction 5 - Table for Proportion ,message=FALSE,warning=FALSE}

#Adding proportion column
`Sample_Size_Proportion` <- (`BBA Regional Richness`-`MC Regional Richness`)/
  (`BBA Regional Richness`-`BBS Regional Richness`)

#Creating dataframe
Sample_Size_Proportion_Data <- data.frame(Region,
                                          `BBA Regional Richness`,
                                          `MC Adjacent Regional Richness`,
                                          `BBS Regional Richness`,
                                     `Sample_Size_Proportion`)

#Outputting table with results
kable(Sample_Size_Proportion_Data,
      caption = "Sample Size Proportional Effect",
      booktabs=T) %>%
  kable_styling(position = "left",
                full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  row_spec(0,color="black")

```


```{r Predictions 4-5 Removing Items to Save Memory, message=FALSE, warning=FALSE}

#removing items from environment
rm(region.test, ma.test, mi.test, ny.test, pa.test, vt.test, #all MC tests
   adj.region.test, adj.ma.test,adj.mi.test,adj.ny.test,adj.pa.test,adj.vt.test, #adj
   
   Region, `MC Regional Richness`,`BBA Regional Richness`, #dataset columns
   `BBS Regional Richness`,`Sample_Size_Contribution`,
   `Sample_Size_Proportion`,`Sample_Size_Effect`,
   `MC Adjacent Regional Richness`,`Adjacent Regional Richness`, #adj
   `Adjacent_Sample_Size_Contribution`,`Sample_Size_Effect_Adjacent`,
   
   Sample_Size_Comparison,Sample_Size_Test,#datasets
   Sample_Size_Proportion_Data,
   Sample_Size_Comparison_Adjacent, #adj
   Sample_Size_Test_Adjacent
   )

```


---

#### Prediction 6

**Local richness in BBA blocks would be higher than that of BBS routes**

This is tested using a GLM model (Poisson error structure) with data source as a fixed effect and state as a random effect using glmer in the lme4 package. 

We also perform a more complex analysis that included the three environmental variables and the three measures of habitat heterogeneity as independent variables.

**Starting with Entire Dataset:**

```{r Prediction 6 simple GLM,message=FALSE, warning=FALSE}

#Response variable is local richness (Atlas2_Total) with Dataset as the fixed effect and State as a random effect, with a Poisson as family

prediction6<- glmer(Atlas2_Total ~ Dataset+
                      (1|State),
               data=full_d, # data
               family=poisson) # poisson

#Output of regression as table
tab_model(prediction6,title="Local Bird Richness by Dataset",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

```




```{r Prediction 6 Plots, message=FALSE, warning=FALSE}

#now plotting the rate ratios between the datasets with p-values
plot_model(prediction6,show.values=T,show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset",
       y="Rate Ratio (BBA to BBS)")+
  theme(plot.title=element_text(hjust=.5))+
  geom_hline(yintercept = 1,linetype="dotted")

#extracting r2
r2.c=round(r.squaredGLMM(prediction6)[1,2],digits=4)
r2.m=round(r.squaredGLMM(prediction6)[1,1],digits=4)

#now plotting the effect with richness on the y-axis
plot_model(prediction6,type="pred",terms ="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset from Model\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=1.5,y=90,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black")+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(50,100))

#now plotting the impact of the random effect of state
plot_model(prediction6,type="re",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Random Effect of State on Species Richness Differences\n(BBA to BBS)",
       y="Rate Ratio (BBA to BBS)",
       x="State")+
  theme(plot.title=element_text(hjust=.5))+
    geom_hline(yintercept = 1,linetype="dotted")


#now plotting predict with state
plot_model(prediction6,type="pred",terms =c("State","Dataset"),
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset from Model\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=3,y=90,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black")+
  scale_color_brewer(type = "qual",palette = 7)+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(50,100))


```



**Now running on Adjacent blocks**:

```{r Prediction 6 simple GLM Adjacent,message=FALSE, warning=FALSE}

#Response variable is local richness (Atlas2_Total) with Dataset as the fixed effect and State as a random effect, with a Poisson as family

adj.prediction6<- glmer(Atlas2_Total ~ Dataset+
                      (1|State),
               data=Adjacent_Full, # data
               family=poisson) # poisson

#Output of regression as table
tab_model(adj.prediction6,title="Local Bird Richness by Dataset Adjacent",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

```




```{r Prediction 6 Adjacent Plots, message=FALSE, warning=FALSE}

#now plotting the rate ratios between the datasets with p-values
plot_model(adj.prediction6,show.values=T,show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Adjacent",
       y="Rate Ratio (BBA to BBS)")+
  theme(plot.title=element_text(hjust=.5))+
  geom_hline(yintercept = 1,linetype="dotted")

#extracting r2
adj.r2.c=round(r.squaredGLMM(adj.prediction6)[1,2],digits=4)
adj.r2.m=round(r.squaredGLMM(adj.prediction6)[1,1],digits=4)

#now plotting the effect with richness on the y-axis
plot_model(adj.prediction6,type="pred",terms ="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Adjacent\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=1.5,y=90,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(50,100))

#now plotting the impact of the random effect of state
plot_model(adj.prediction6,type="re",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Random Effect of State on Species Richness Differences\n(Adj to BBS)",
       y="Rate Ratio (Adj to BBS)",
       x="State")+
  theme(plot.title=element_text(hjust=.5))+
    geom_hline(yintercept = 1,linetype="dotted")


#now plotting predict with state
plot_model(adj.prediction6,type="pred",terms =c("State","Dataset"),
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Adjacent\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=3,y=90,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  scale_color_brewer(type = "qual",palette = 7)+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(50,100))


```


**Now running on Well Sampled Blocks (>30hr effort in Block)**
```{r Prediction 6 simple GLM Sampled,message=FALSE, warning=FALSE}

#Response variable is local richness (Atlas2_Total) with Dataset as the fixed effect and State as a random effect, with a Poisson as family

sampled.prediction6<- glmer(Atlas2_Total ~ Dataset+
                      (1|State),
               data=SampledFull, # data
               family=poisson) # poisson

#Output of regression as table
tab_model(sampled.prediction6,
          title="Local Bird Richness by Dataset Sampled",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

```


*Plotting model results*

```{r Prediction 6 Sampled Plots, message=FALSE, warning=FALSE}

#now plotting the rate ratios between the datasets with p-values
plot_model(sampled.prediction6,show.values=T,show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Sampled",
       y="Rate Ratio (BBA to BBS)")+
  theme(plot.title=element_text(hjust=.5))+
  geom_hline(yintercept = 1,linetype="dotted")

#extracting r2
adj.r2.c=round(r.squaredGLMM(sampled.prediction6)[1,2],digits=4)
adj.r2.m=round(r.squaredGLMM(sampled.prediction6)[1,1],digits=4)

#now plotting the effect with richness on the y-axis
plot_model(sampled.prediction6,type="pred",terms ="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Sampled\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=1.5,y=90,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(70,100))

#now plotting the impact of the random effect of state
plot_model(sampled.prediction6,type="re",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Random Effect of State on Species Richness Differences\n(Sampled BBA to BBS)",
       y="Rate Ratio (BBA to BBS)",
       x="State")+
  theme(plot.title=element_text(hjust=.5))+
    geom_hline(yintercept = 1,linetype="dotted")


#now plotting predict with state
plot_model(sampled.prediction6,type="pred",terms =c("State","Dataset"),
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Sampled\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=3,y=90,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  scale_color_brewer(type = "qual",palette = 7)+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(70,100))


```



**Now running on well sampled and adjacent**

```{r Prediction 6 simple GLM Sampled Adjacent,message=FALSE, warning=FALSE}

#Response variable is local richness (Atlas2_Total) with Dataset as the fixed effect and State as a random effect, with a Poisson as family

sampled.adj.prediction6<- glmer(Atlas2_Total ~ Dataset+
                      (1|State),
               data=SampledAdj_Full, # data
               family=poisson) # poisson

#Output of regression as table
tab_model(sampled.adj.prediction6,
          title="Local Bird Richness by Dataset Sampled Adjacent",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

```


*Plotting model results*

```{r Prediction 6 Sampled Adjacent Plots, message=FALSE, warning=FALSE}

#now plotting the rate ratios between the datasets with p-values
plot_model(sampled.adj.prediction6,show.values=T,show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Sampled Adjacent",
       y="Rate Ratio (BBA to BBS)")+
  theme(plot.title=element_text(hjust=.5))+
  geom_hline(yintercept = 1,linetype="dotted")

#extracting r2
adj.r2.c=round(r.squaredGLMM(sampled.adj.prediction6)[1,2],digits=4)
adj.r2.m=round(r.squaredGLMM(sampled.adj.prediction6)[1,1],digits=4)

#now plotting the effect with richness on the y-axis
plot_model(sampled.adj.prediction6,
           type="pred",terms ="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Sampled Adjacent\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=1.5,y=90,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(70,100))

#now plotting the impact of the random effect of state
plot_model(sampled.adj.prediction6,type="re",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Random Effect of State on Species Richness Differences\n(Sampled Adj to BBS)",
       y="Rate Ratio (BBA to BBS)",
       x="State")+
  theme(plot.title=element_text(hjust=.5))+
    geom_hline(yintercept = 1,linetype="dotted")


#now plotting predict with state
plot_model(sampled.adj.prediction6,
          type="pred",terms =c("State","Dataset"),
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Sampled Adjacent\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=3,y=90,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  scale_color_brewer(type = "qual",palette = 7)+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(70,100))


```



---

**Now running model with environmental and heterogeneity variables**

```{r Prediction 6 full GLM, message=FALSE, warning=FALSE}

prediction6.2 <- glmer(Atlas2_Total ~ 
                       Dataset   #ata source and effort
                       +scale(Precipitation)  #precipitation
                       +scale(Temp)  #summer temperature
                       +scale(Elev_Mean)  #elevation mean in block/route
                       +scale(Elev_Range)  #elevation range in block/route
                       +scale(Het_Count2006)  # land-class richness
                       +scale(Shannon2006) # land-class diversity (Shannon-Wiener index)
                       +(1|State), #state as random effect
                       data=full_d, # data
                     family=poisson) # family poisson

#AIC checking which is best model
#step(prediction6.2)

#Output of regression as table
tab_model(prediction6.2,
          title="Local Bird Richness by Dataset",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE"
          ) %>%
  return() %$% 
    knitr %>% 
    asis_output()


```



```{r Prediction 6 full GLM plots, message=FALSE, warning=FALSE}

#Plotting model
plot_model(prediction6.2,show.values = T,show.p=T,show.intercept = T)+theme_classic()+
  labs(title="GLM All Factors Contributing to Local Richness")

#extracting r2
r2.c=round(r.squaredGLMM(prediction6.2)[1,2],digits=4)
r2.m=round(r.squaredGLMM(prediction6.2)[1,1],digits=4)

#now plotting the effect with richness on the y-axis
plot_model(prediction6.2,type="pred",terms ="Dataset",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Full GLM\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=1.5,y=40,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(20,50))

#now plotting the impact of the random effect of state
plot_model(prediction6.2,type="re",
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Random Effect of State Full GLM\n(BBA to BBS)",
       y="Rate Ratio (BBA to BBS)",
       x="State")+
  theme(plot.title=element_text(hjust=.5))+
    geom_hline(yintercept = 1,linetype="dotted")


#now plotting predict with state
plot_model(prediction6.2,type="pred",terms =c("State","Dataset"),
           show.values = T,
           show.p=T)+theme_classic()+
  labs(title="Local Bird Richness by Dataset Full GLM\n(State as random effect)",
       x="Dataset",
       y="Predicted Bird Species Richness")+
   geom_label(aes(x=3,y=45,
                 label=paste("Marginal R2=",adj.r2.m, 
                             "\nConditional R2=",adj.r2.c)),col="black")+
  scale_color_brewer(type = "qual",palette = 7)+
  theme(plot.title=element_text(hjust=.5))+
  scale_y_continuous(limits=c(20,50))

```


```{r Prediction 6 full GLM individual effects, message=FALSE, warning=FALSE}

#Just Dataset
plot(effect("Dataset",prediction6.2))

#Precipitation
plot(effect("Precipitation",prediction6.2))

#Temperature
plot(effect("Temp",prediction6.2))

#Elevation
plot(effect("Elev_Mean",prediction6.2))

#Elevation Range
plot(effect("Elev_Range",prediction6.2))

#Land-Class Richness
plot(effect("Het_Count2006",prediction6.2))

#Land-Class Diversity
plot(effect("Shannon2006",prediction6.2))


```


---


#### Prediction 7  

**Compositional turnover among BBA blocks is higher than BBS routes**

**Calculating Jaccard Index of Dissimilarity for data**

Using vegan package to calculate Jaccard dissimilarity and then pulling mean out from data

```{r Prediction 7 Jaccard Datasets, warning=FALSE, include=FALSE}

#Calculating Jaccard Index 
bs=vegdist(BBS[14:291],method="jaccard",binary=T)
#Turning into a vector
bs <- as.vector(bs)
#Now making a dataset column
bs<- as.data.frame(bs)
bs$Dataset <- "BBS"
colnames(bs) <- c("Jaccard","Dataset")
#Checking
#str(bs)

#now for BBA
ba=vegdist(BBA[14:291],method="jaccard",binary=T)
#Turning into a vector
ba <- as.vector(ba)
#Now making a dataset column
ba<- as.data.frame(ba)
ba$Dataset <- "BBA"
colnames(ba) <- c("Jaccard","Dataset")
#Checking
#str(ba)

#Now for each state

mabs=vegdist(MABBS[14:291],method="jaccard",binary=T)
mabs <- as.vector(mabs)
#Now making a dataset column
mabs<- as.data.frame(mabs)
mabs$Dataset <- "MABBS"
colnames(mabs) <- c("Jaccard","Dataset")

maba=vegdist(MABBA[14:291],method="jaccard",binary=T)
maba <- as.vector(maba)
#Now making a dataset column
maba<- as.data.frame(maba)
maba$Dataset <- "MABBA"
colnames(maba) <- c("Jaccard","Dataset")


mibs=vegdist(MIBBS[14:291],method="jaccard",binary=T)
mibs <- as.vector(mibs)
#Now miking a dataset column
mibs<- as.data.frame(mibs)
mibs$Dataset <- "MIBBS"
colnames(mibs) <- c("Jaccard","Dataset")

miba=vegdist(MIBBA[14:291],method="jaccard",binary=T)
miba <- as.vector(miba)
#Now miking a dataset column
miba<- as.data.frame(miba)
miba$Dataset <- "MIBBA"
colnames(miba) <- c("Jaccard","Dataset")


nybs=vegdist(NYBBS[14:291],method="jaccard",binary=T)
nybs <- as.vector(nybs)
#Now nyking a dataset column
nybs<- as.data.frame(nybs)
nybs$Dataset <- "NYBBS"
colnames(nybs) <- c("Jaccard","Dataset")

nyba=vegdist(NYBBA[14:291],method="jaccard",binary=T)
nyba <- as.vector(nyba)
#Now nyking a dataset column
nyba<- as.data.frame(nyba)
nyba$Dataset <- "NYBBA"
colnames(nyba) <- c("Jaccard","Dataset")


pabs=vegdist(PABBS[14:291],method="jaccard",binary=T)
pabs <- as.vector(pabs)
#Now paking a dataset column
pabs<- as.data.frame(pabs)
pabs$Dataset <- "PABBS"
colnames(pabs) <- c("Jaccard","Dataset")

paba=vegdist(PABBA[14:291],method="jaccard",binary=T)
paba <- as.vector(paba)
#Now paking a dataset column
paba<- as.data.frame(paba)
paba$Dataset <- "PABBA"
colnames(paba) <- c("Jaccard","Dataset")


vtbs=vegdist(VTBBS[14:291],method="jaccard",binary=T)
vtbs <- as.vector(vtbs)
#Now vtking a dataset column
vtbs<- as.data.frame(vtbs)
vtbs$Dataset <- "VTBBS"
colnames(vtbs) <- c("Jaccard","Dataset")

vtba=vegdist(VTBBA[14:291],method="jaccard",binary=T)
vtba <- as.vector(vtba)
#Now vtking a dataset column
vtba<- as.data.frame(vtba)
vtba$Dataset <- "VTBBA"
colnames(vtba) <- c("Jaccard","Dataset")

```


**Running permutation two-tailed t test**

Running a permutation t-test using perm.t.test from the GmAMisc package, with 1000 permutations.
This will see if BBA or BBS are more or less dissimilar internally in terms of species composition (using the Jaccard Index as a measure of distance between two sites).


*Starting with entire dataset:*

```{r Prediction 7 Regional Permutation Jaccard Test, message=F,warning=FALSE}
#Running permutation test that takes as arguments the dataframe we just created, 
#the format is short (meaning there are two columns, one for each dataset).
#Then labeling each variable we're comparing, and saying run 1000 permutations

region.perm.test <- list(ba,bs)
region.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),region.perm.test, accumulate=FALSE)

perm.t.test(region.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(ba,bs,region.perm.test)
```


*Now running for every state (long format)*

MA
```{r Prediction 7 MA Permutation Test, message=F, warning=F}
#MA
ma.perm.test <- list(mabs,maba)
ma.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),ma.perm.test, accumulate=FALSE)

perm.t.test(ma.perm.test,
           format = "long",
            sample1.lab = "MABBA",
            sample2.lab = "MABBS",
            B=1000)

#removing from environment to save space
rm(maba,mabs,ma.perm.test)
```


MI
```{r Prediction 7 MI Permutation Test, message=FALSE, warning=FALSE}
#MI
mi.perm.test <- list(mibs,miba)
mi.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),mi.perm.test, accumulate=FALSE)

perm.t.test(mi.perm.test,
            format = "long",
            sample1.lab = "MIBBA",
            sample2.lab = "MIBBS",
            B=1000)

#removing from environment to save space
rm(miba,mibs,mi.perm.test)
```


NY
```{r Prediction 7 NY Permutation Test, message=FALSE, warning=FALSE}
#NY
ny.perm.test <- list(nybs,nyba)
ny.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),ny.perm.test, accumulate=FALSE)

perm.t.test(ny.perm.test,
            format = "long",
            sample1.lab = "NYBBA",
            sample2.lab = "NYBBS",
            B=1000)

#removing from environment to save space
rm(nyba,nybs,ny.perm.test)
```


PA
```{r Prediction 7 PA Permutation Test, message=FALSE, warning=FALSE}
#PA
pa.perm.test <- list(pabs,paba)
pa.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),pa.perm.test, accumulate=FALSE)

perm.t.test(pa.perm.test,
            format = "long",
            sample1.lab = "PABBA",
            sample2.lab = "PABBS",
            B=1000)

#removing from environment to save space
rm(paba,pabs,pa.perm.test)
```


VT
```{r Prediction 7 VT Permutation Test, message=FALSE, warning=FALSE}
vt.perm.test <- list(vtbs,vtba)
vt.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),vt.perm.test, accumulate=FALSE)

perm.t.test(vt.perm.test,
            format = "long",
            sample1.lab = "VTBBA",
            sample2.lab = "VTBBS",
            B=1000)

#removing from environment to save space
rm(vtba,vtbs,vt.perm.test)
```



---

##### Running Ordinal Test for Prediction 7

Now we will do a similar test to check differences in species composition between BBA and BBS using Jaccard as our distance. 
However, this time we'll run a nonmetric multidimensional ordination analysis (NMDS) using the vegan package. 
Then we'll run a distance-based test for homogeneity of multivariate dispersion also using betadisper in vegan.

**Setting up Ordination**
```{r Prediction 7 Ordination,message=FALSE, warning=FALSE}

#Subsetting predictor variables and then species matrix from full data
ordination.prediction7 <- full_d[c(2:3,14:291)]

#running jaccard distance calclation
ordination.dist = vegdist(ordination.prediction7[3:280], 
                          method = "jaccard", 
                          binary = T)

#predictor variables
ordination.pred <- ordination.prediction7[1:2]

```


**Outputting Results**
```{r Prediction 7 Ordination Results}
#running distance-based test for homogeneity of multivariate dispersion 
prediction7 <- betadisper(ordination.dist,
                          group=ordination.pred$Dataset,
                          type="centroid")

#summary of test
prediction7

#ANOVA
anova(prediction7)

#TukeyHSD significance test
TukeyHSD(prediction7)

#saving object since it's so painstaking to run
save(prediction7, file="Prediction 7 Ordination.RData")

```


**Plotting Results**
```{r Prediction 7 Ordination Plots, message=FALSE, warning=FALSE}
#boxplot
boxplot(prediction7, 
        main="Prediction 7 - Homogeneity of Multivariate Dispersion",
        xlab="Dataset",
        ylab="Distance to Centroid",
        notch=F, col=c("#66C2A5","#FC8D62"))


#ordination plot

#calculating ordination % variance explained
labs <- paste("Dimension", "(", 
              round(100*prediction7$eig / sum(prediction7$eig), 2), "%)")

# #plotting
# myplotbetadisper(prediction7,pch=1:2,
#      col=scales::alpha(c("#66C2A5","#FC8D62"),1),
#      hull=T,lwd=2,
#      seg.col=scales::alpha("grey",0.05),
#      label=F,
#      alphaPoints=1,
#      main="Prediction 7 - Homogeneity of Multivariate Dispersion", 
#      xlab=labs[1], ylab=labs[2],
#      cex.lab=1.25
#      )

#remove from environment
rm(ordination.pred,ordination.dist,ordination.prediction7)
```


---


#### Prediction 8

**Some of the variation in local richness among BBA blocks and BBS routes would be accounted for by underlying differences in sampling effort**


This is tested in two steps:  

- First, we regress local richness of all BBA blocks and BBS routes against sampling effort (number of survey hours) using GLM with Poisson error structure to verify that local richness in the two data sources is influenced by sampling effort.  
  1. We also run an extended GLM with local richness as the response variable and sampling effort, the three environmental variables (elevation, precipitation, and temperature), the three measures of habitat heterogeneity (elevation range, land-cover richness, and land-cover diversity), data source, the interaction between sampling effort and data source, and state (as a random factor) as independent variables.  
  2. We expect that the effect of sampling effort would be statistically significant also in this extended model.  

- In a second step, we match each BBS route with a single BBA block (the one with the largest overlap with that route based on area), thereby, creating a set of matched pairs of BBA and BBS units.  
  1. We then calculate the difference in richness between the BBA block and BBS route in each pair (as a response variable) and regress the difference in richness against the corresponding difference in sampling effort using GLM with state as a random effect.  
  2. We expect that much of the differences in local richness between matched BBA blocks and BBS routes would be accounted for by the corresponding differences in sampling effort.


**First running regression with richness as response and effort as predictor**

```{r Prediction 8 simple GLM, message=FALSE,warning=FALSE}

#Running model
prediction8.1 <- glm(logRichness ~ logEffort, # response and predictor
                     data=full_d, # data
        family=poisson) # poisson distribution


## table of model
tab_model(prediction8.1,
          title="Local Bird Richness by Effort (in hours)",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE")%>%
  return() %$% 
    knitr %>% 
    asis_output()


## plotting model
plot_model(prediction8.1,type="pred",
           terms="logEffort",
           show.values=T,
           show.p=T)+
  theme_classic()+
  labs(title="Local Bird Richness by Effort (in hours)")


```



**Now running GLM with effort as interaction with data source and including all other variables as predictors**

```{r Prediction 8 Full GLM,message=FALSE,warning=FALSE}

#adding scaled log effort
full_d<- full_d %>%
  mutate(standard.effort = scale(logEffort))
  

#Running GLM
prediction8.2 <- glm(logRichness ~ 
                       standard.effort*Dataset   # interaction of data source and effort
                       +scale(Precipitation)  #precipitation
                       +scale(Temp)  #summer temperature
                       +scale(Elev_Mean)  #elevation mean in block/route
                       +scale(Elev_Range)  #elevation range in block/route
                       +scale(Het_Count2006)  # land-class richness
                       +scale(Shannon2006), # land-class diversity (Shannon-Wiener index)
                       data=full_d, # data
                     family=poisson) # family poisson

#AIC checking which is best model
#step(prediction8.2)

#table of model
tab_model(prediction8.2,
          title="Local Bird Richness by Effort Full GLM",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE")%>%
  return() %$% 
    knitr %>% 
    asis_output()

```


**Plotting full GLM**

```{r Prediction 8 Full GLM Plots, message=FALSE, warning=FALSE}

#rsquared
r2=round(rsq(prediction8.2,adj=T),digits=4)

#Plotting model
plot_model(prediction8.2,
           show.values = T,
           show.p=T,
           show.intercept = T)+theme_classic()+
geom_label(aes(x=5,y=5,
                 label=paste("R2=",r2)),col="black")+
  labs(title="GLM All Factors Contributing to Local Richness")


#Plotting interaction of Dataset and Effort
plot(effect(c("standard.effort","Dataset"),prediction8.2))

#Just effort
plot(effect("standard.effort",prediction8.2))

#Just Dataset
plot(effect("Dataset",prediction8.2))

#Precipitation
plot(effect("Precipitation",prediction8.2))

#Temperature
plot(effect("Temp",prediction8.2))

#Elevation
plot(effect("Elev_Mean",prediction8.2))

#Elevation Range
plot(effect("Elev_Range",prediction8.2))

#Land-Class Richness
plot(effect("Het_Count2006",prediction8.2))

#Land-Class Diversity
plot(effect("Shannon2006",prediction8.2))


```


**Now running regression on geographically matched pairs of BBA and BBS blocks (with most overlap) - difference in richness by difference in effort with state as a random effect**


```{r Prediction 8 Matched SU, message=FALSE, warning=FALSE}

#Creating difference in log richness and log effort columns and subsetting data for test
prediction8.data <- Matched %>%
  mutate(Richness_Diff = ifelse(BBSID==lag(BBSID),lag(logRichness)-logRichness,NA),
         Effort_Diff = ifelse(BBSID==lag(BBSID),lag(logEffort)-logEffort,NA)
                                ) %>%
    dplyr::select(BBSID,State,Richness_Diff,Effort_Diff) %>%
  filter(!is.na(Richness_Diff))

#Running GLM
prediction8.3 <- glmer(Richness_Diff ~ Effort_Diff+(1|State),
                       data=prediction8.data)


#table of model
tab_model(prediction8.3,
          title="GLM Difference Richness by Difference Effort\nMatched Sampling Units",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE")%>%
  return() %$% 
    knitr %>% 
    asis_output()

```


*Plotting model output*

```{r Prediction 8 Matched SU Plots, message=FALSE, warning=FALSE}

# pulling predictions from model and confidence intervals
pred <- cbind(prediction8.data, 
              predictInterval(prediction8.3, prediction8.data)) 

#r-squared
x=r.squaredGLMM(prediction8.3)
r2=round(x[1],digits=2)

#intercept
t=summary(prediction8.3)
x2=t$coefficients
intercept=round(x2[1],digits=4)

#slope
slope=round(x2[2],digits=4)

#plotting
pred %>%
  ggplot(aes(Effort_Diff, Richness_Diff)) + 
  geom_point(aes(color=State))+
  scale_color_brewer(type = "qual",palette = 2)+
  geom_line(aes(Effort_Diff, fit),alpha=0.5)+
  geom_ribbon(aes(Effort_Diff, ymin = lwr, ymax = upr), alpha = 0.1)+
  geom_label(aes(x=2.5,y=-1.5,
                 label=paste("R2=",r2,"\ny=",
                             intercept,"+",slope,"* Effort Difference")),
             col="black",
             label.size = NA)+
  theme_classic()+
  labs(title="GLM Richness Difference by Difference Effort (BBA-BBS)\nGeographically Matched Pairs",
       x="Difference in Log Effort per Sampling Unit (BBA-BBS)",
       y="Difference in Log Richness per Sampling Unit (BBA-BBS)")+
  theme(plot.title=element_text(hjust=0.5))

```



---

**Now running model on means of richness per block with means of effort**


```{r Prediction 8 Means by State,message=FALSE,warning=FALSE}

#Creating summary table of mean log effort and mean log richness
summary_table8 <- full_d %>%
  filter(logEffort!="-Inf") %>%
  group_by(Dataset,State) %>% #grouping by dataset and state
  summarize(mean_richness = mean(logRichness,na.rm=T),
            mean_effort = mean(logEffort,na.rm=T))


#Running regression to fit into graph
prediction8.4 <- glm(mean_richness ~ 
                       Dataset * mean_effort,
                     data=summary_table8)

#output table
tab_model(prediction8.4,
          title="GLM Mean Richness by Mean Effort",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE")%>%
  return() %$% 
    knitr %>% 
    asis_output()

```

*Now plotting*

```{r Prediction 8 Mean Richness Plot, message=FALSE, warning=FALSE}

#r-squared
x=rsq(prediction8.4,adj=T)
r2=round(x[1],digits=2)

#intercept
x2=prediction8.4$coefficients
intercept=round(x2[1],digits=4)

#slope
slope=round(x2[3],digits=4)

predict8.4 <- predict.glm(prediction8.4,se.fit=T,type="link")

make_ci <- function(pred, data){

# fit, lower, and upper CI
fit <- pred$fit
lower <- fit - 1.96*pred$se.fit
upper <- fit + 1.96*pred$se.fit

return(data.frame(fit, lower, upper, data))
}

my_pred <- make_ci(predict8.4, summary_table8)

#Plotting Means by State
my_pred %>%
  ggplot(aes(x=mean_effort,y=mean_richness,group=Dataset,color=Dataset))+
  geom_point(size=2)+
  geom_line(aes(x = mean_effort, y = fit))+
  scale_color_brewer(type = "qual",palette = 7)+
  geom_ribbon(aes(mean_effort, ymin = lower, ymax = upper), alpha = 0.05,colour = NA)+
  geom_text(aes(mean_effort,mean_richness,label=State),size=2.5,vjust=-2,face="bold")+
  geom_label(aes(x=3.5,y=4,
                 label=paste("R2=",r2,"\ny=",intercept,"+",slope,"* mean effort")),
             col="black",
             label.size = NA)+
  theme_classic()+
  labs(title="Prediction 8 - Effort Impacts Local Richness",
       x="Mean Log Hours in Sampling Unit",
       y="Mean Log Species Richness in Sampling Unit")+
  theme(plot.title = element_text(hjust=0.5))
    


```

**Now running regression comparing differences in mean richness vs. differences in mean effort**

```{r Prediction 8 Mean Richness Difference,message=FALSE,warning=FALSE}

#Creating summary table with difference columns in richness and effort
summary_table8.2 <- summary_table8 %>%
  pivot_wider(names_from = Dataset,
              values_from = c(mean_richness,mean_effort))%>%
  mutate(richness_difference = mean_richness_BBA - mean_richness_BBS,
         effort_difference = mean_effort_BBA - mean_effort_BBS)%>%
  dplyr::select(State,richness_difference,effort_difference)
              

#Now running GLM with difference mean richness as response and difference mean effort as predictor
prediction8.5 <- glm(richness_difference ~ effort_difference,
                     data=summary_table8.2)

#r-squared
x3=rsq(prediction8.5,adj=T)
r2=round(x3[1],digits=2)

#intercept
x4=prediction8.5$coefficients
intercept=round(x4[1],digits=4)

#slope
slope=round(x4[2],digits=4)

#fitted predictions and CIs
predict8.5 <- predict.glm(prediction8.5,se.fit=T,type="link")

my_pred <- make_ci(predict8.5, summary_table8.2)

View(my_pred)
range(my_pred$effort_difference)

#Plotting Means by State
my_pred %>%
  ggplot(aes(x=effort_difference,y=richness_difference))+
  geom_point(size=4,aes(color=State))+
  geom_line(aes(x = effort_difference, y = fit))+
  scale_color_brewer(type = "qual",palette = 7)+
  geom_ribbon(aes(effort_difference, ymin = lower, ymax = upper), alpha = 0.05,colour = NA)+
   geom_text(aes(effort_difference,richness_difference,label=State),size=2,vjust=-2)+
  geom_label(aes(x=1.25,y=-0.4,
                 label=paste("R2=",r2,"\ny=",intercept,"+",slope,"* Mean Difference in Effort")),
             col="black",
             label.size=NA)+
  theme_classic()+
  labs(title="Prediction 8 - Effort Impacts Local Richness",
       x="Mean Difference Log Effort",
       y="Mean Difference Log Species Richness")+
  theme(legend.position = "none")+
  theme(plot.title = element_text(hjust=0.5))+
  scale_x_continuous(breaks=seq(-0.7,2,0.5))


```

```{r Prediction 8 removing items,message=FALSE, warning=FALSE}

rm(my_pred,pred,predict8.4,predict8.5,
   prediction8.data,
   t,
   summary_table8,summary_table8.2,
   intercept,r2,slope,x,x2,x3,x4)

```


  
***
***

## Ad-hoc Analyses  


#### Ad-hoc 1 

**Regional richness estimates for BBS based on extrapolation analyses will still be lower than the observed regional richness in BBA** 

We test this by running estimates of regional richness of BBS data (n=281) based on 3 extrapolation/rarefaction methods -  

 1. Chao2  
 2. Jacknife (1st and 2nd order)  
 3. Bootstrap  
 
Richness estimates are calculated using the specpool function in the vegan package.

We run this for the entire study region and also separately for each state.

We then compare the extrapolation results to the observed regional richness of the corresponding BBA region. The observed richness in BBA is a minimum (i.e. no extrapolation).

We hypothesize that even after running extrapolation analyses, BBS regional richness will still not reach the minimum richness as observed in BBA.


```{r Ad-hoc 1 extrapolations BBS, message=FALSE, warning=FALSE}

#Running extrapolation on species matrix, separately by State
ad.hoc.1 <- specpool(BBS[,14:291],BBS$State)
#checking
#ad.hoc.1

#Running on entire dataset
ad.hoc.1b <- specpool(BBS[,14:291])
#checking
#ad.hoc.1b

#joining together
ad.hoc1.data<-rbind(ad.hoc.1b,ad.hoc.1)

#removing unnecessary things
rm(ad.hoc.1,ad.hoc.1b)

#renaming columns
ad.hoc1.data <- tibble::rownames_to_column(ad.hoc1.data,"Region")

colnames(ad.hoc1.data) <- c("Region","BBS Observed Gamma",
                           "Chao","Chao SE","Jacknife 1","Jacknife 1 SE",
                           "Jacknife 2",
                           "Bootstrap", "Bootstrap SE","BBS n")

#Standard error data
extrapolation.se <- ad.hoc1.data %>%
  dplyr::select(Region, `Chao SE`,`Jacknife 1 SE`,`Bootstrap SE`)

#Just estimates data
ad.hoc1.data <- ad.hoc1.data %>%
  dplyr::select(-`Chao SE`,-`Jacknife 1 SE`,-`Bootstrap SE`)

#Adding Observed BBA regional estimate
`BBA Observed Gamma` <-c(274,220,235,247,202,192)

#Finalizing table
ad.hoc1.data <- cbind(ad.hoc1.data,`BBA Observed Gamma`) %>%
  setcolorder(.,c("Region","BBA Observed Gamma",
                  "BBS Observed Gamma","Chao","Jacknife 1","Jacknife 2","Bootstrap",
                  "BBS n"))

#adding column whether extrapolation reaches observed BBA richness
ad.hoc1.data <- ad.hoc1.data %>%
  dplyr::select(-"BBS n") %>%
  mutate(`Extrapolation Reaches BBA`=ifelse(
    `BBA Observed Gamma`>`Jacknife 2`,"No","Yes"),
    Chao.perc = (Chao / `BBA Observed Gamma`)*100,
    Jacknife1.perc = (`Jacknife 1` / `BBA Observed Gamma`)*100,
    Jacknife2.perc = (`Jacknife 2`/`BBA Observed Gamma`)*100,
    Bootstrap.perc = (Bootstrap/`BBA Observed Gamma`)*100
    )

#outputting table
kable(ad.hoc1.data,
      caption = "Extrapolation BBS compared to Observed BBA",
      booktabs=T) %>%
  kable_styling(position = "left",
                full_width = F) %>%
  column_spec(1, bold = T, border_right = T) %>%
  row_spec(0,color="black")

#removing from environment
#rm(extrapolation.se,`BBA Observed Gamma`)

```


---


#### Ad-hoc 2

**A species' presence in BBA and absence in BBS will be explained either by its relative rareness or by its presence in a climatic habitat that isn't sampled by the BBS**

Testing this by calculating for each species:  
  1. Its rareness (# of blocks present) in BBA  
  2. Propotion of blocks present in climatic conditions not sampled by BBS  
  3. Whether it was absent or present in BBS

Climatic conditions (precipitation and temperature) are defined as BBA routes where those environmental variables lie outside the range seen in the BBS dataset.

We then run a GLM binomial regression (logit-link) with absence from BBS as response, and rareness and climatic condition as predictors.

We run this model for each environmental variable separately.

We also run it two ways:  
  1. For each state separately
  2. For the entire region with state as a random effect


**First creating datasets for analyses**

```{r Ad-hoc2 BBS Absence Data Formation, message=FALSE, warning=FALSE}

#Creating dataframe of species rareness and absence from BBS
#for entire region (subsetting ID, Dataset, State, Species, and Climate)
ad.hoc2.data <- full_d[c(1:3,14:291,299,301)]

#Now using pivot_longer() to turn species into a column

ad.hoc2.data<-ad.hoc2.data %>%
  pivot_longer(c("Acadian Flycatcher":"Yellow-throated Warbler"), #columns
               names_to = "Species", # name new variable
               values_to = "Observations" # name value column
  )

#Adding environmental ranges by State
ranges <- BBS %>%
  group_by(State) %>%
  summarize(BBS_min_prec=min(Precipitation,na.rm=T),
            BBS_max_prec=max(Precipitation,na.rm=T),
            BBS_min_temp=min(Temp,na.rm=T),
            BBS_max_temp=max(Temp,na.rm=T))

#list
df_list <- list(ad.hoc2.data,ranges) #making list
#merging
ad.hoc2.data2<- Reduce(function(x,y) merge(x,y,all=TRUE),df_list, accumulate=FALSE)

#remove unnecessary items
rm(ranges,df_list,ad.hoc2.data)

#Creating column of whether bird was present in climate unsampled by BBS
ad.hoc2.data2 <- ad.hoc2.data2 %>%
  mutate(Precipitation_Outside_Range = 
           ifelse(Precipitation<BBS_min_prec,
                  1,
                  ifelse(Precipitation>BBS_max_prec,
                         1,
                         0)),
         Temp_Outside_Range = 
           ifelse(Temp<BBS_min_temp,
                  1,
                  ifelse(Temp>BBS_max_temp,
                         1,
                         0)),
         BBS_Presence=ifelse(Dataset=="BBS" & Observations==1,
                             1,
                             0)
         )

#Subsetting data where each row is a species with rareness, environmental habitat,
#and presence/absence from BBS

ad.hoc2.analysis <- ad.hoc2.data2 %>%
  filter(Observations==1) %>%
  group_by(Species,State) %>%
  dplyr::summarize(Rareness=sum(Observations),
                   BBS_Presence = sum(BBS_Presence),
            Proportion_Prec_NotSampled=sum(Precipitation_Outside_Range,na.rm=T)/n(),
            Proportion_Temp_NotSampled=sum(Temp_Outside_Range,na.rm=T)/n()) %>%
  mutate(BBS_Presence = ifelse(BBS_Presence>0,1,0))%>%
  arrange(Rareness)

#Subsetting without state information

ad.hoc2.analysis2 <- ad.hoc2.data2 %>%
  filter(Observations==1) %>%
  group_by(Species) %>%
  dplyr::summarize(Rareness=sum(Observations),
                   BBS_Presence = sum(BBS_Presence),
            Proportion_Prec_NotSampled=sum(Precipitation_Outside_Range,na.rm=T)/n(),
            Proportion_Temp_NotSampled=sum(Temp_Outside_Range,na.rm=T)/n()) %>%
  mutate(BBS_Presence = ifelse(BBS_Presence>0,1,0))%>%
  arrange(Rareness)


#removing unnecessary from environment
rm(ad.hoc2.data2)


```

**Tallying how many BBA blocks lie outside of climatic BBS range**

```{r BBA Outside BBS range, message=FALSE, warning=FALSE}


ranges <- BBS %>%
  group_by(State) %>%
  summarize(BBS_min_prec=min(Precipitation,na.rm=T),
            BBS_max_prec=max(Precipitation,na.rm=T),
            BBS_min_temp=min(Temp,na.rm=T),
            BBS_max_temp=max(Temp,na.rm=T))

df_list2 <- list(ranges,full_d)

prop.habitat<- Reduce(function(x,y) merge(x,y,all=TRUE),df_list2, accumulate=FALSE)

prop.habitat <- prop.habitat %>%
  filter(!is.na(Precipitation),
         !is.na(Temp)) %>%
  dplyr::select(Dataset,State,X,Y,Precipitation,
                Temp,Elev_Mean,
                BBS_min_prec,BBS_max_prec,
                BBS_min_temp,BBS_max_temp) %>%
  mutate(Precipitation_Outside_Range = 
           ifelse(Precipitation<BBS_min_prec,
                  1,
                  ifelse(Precipitation>BBS_max_prec,
                         1,
                         0)),
         Temp_Outside_Range = 
           ifelse(Temp<BBS_min_temp,
                  1,
                  ifelse(Temp>BBS_max_temp,
                         1,
                         0)))

#tallying precipitation
tally(~Precipitation_Outside_Range,data=prop.habitat)
tally(~Precipitation_Outside_Range,data=prop.habitat,format="percent")

#by state
tally(~Precipitation_Outside_Range|State,data=prop.habitat)
tally(~Precipitation_Outside_Range|State,
      data=prop.habitat,format="percent")

#tallying temperature
tally(~Temp_Outside_Range,data=prop.habitat)
tally(~Temp_Outside_Range,data=prop.habitat,format="percent")

#by state
tally(~Temp_Outside_Range|State,data=prop.habitat)
tally(~Temp_Outside_Range|State,
      data=prop.habitat,format="percent")


#removing things from environment
rm(ranges,prop.habitat,df_list2)


```


**Running Binomial GLM for entire dataset**

```{r BBS Absence Entire Region test, message=FALSE, warning=FALSE}

#run model for precipitation
bbs.absence <- glm(BBS_Presence ~ #presence in BBS response
                        Rareness #rareness of appearance in BBA
                      + Proportion_Prec_NotSampled, #proportion blocks outside BBS range
                      data=ad.hoc2.analysis2, #data
                      family=binomial) #binomial regression (Defaults to logit link)

#Output model
tab_model(bbs.absence,
          title="BBS Absence by Precipitation and Rareness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

#visualizing model
plot_model(bbs.absence,
           type="pred",
           terms="Rareness",
           se=T)+
  theme_classic()


#===

#run model for temperature
bbs.absence1 <- glm(BBS_Presence ~ #presence in BBS response
                        Rareness #rareness of appearance in BBA
                      + Proportion_Temp_NotSampled, #proportion blocks outside BBS range
                      data=ad.hoc2.analysis2, #data
                      family=binomial) #binomial regression (Defaults to logit link)

#Output model
tab_model(bbs.absence1,
          title="BBS Absence by Temperature and Rareness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

#===

#run model for both

#run model for precipitation
bbs.absence2 <- glm(BBS_Presence ~ #presence in BBS response
                        Rareness #rareness of appearance in BBA
                      + Proportion_Prec_NotSampled #proportion blocks outside BBS range
                      + Proportion_Temp_NotSampled,
                      data=ad.hoc2.analysis2, #data
                      family=binomial) #binomial regression (Defaults to logit link)

#Output model
tab_model(bbs.absence2,
          title="BBS Absence by Climate and Rareness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE",
          show.r2 = T) %>%
  return() %$% 
    knitr %>% 
    asis_output()

#visualizing model
plot_model(bbs.absence,
           se=T)+
  theme_classic()


```





**Running Binomial GLM for entire dataset with state as random effect**

```{r BBS Absence State Level test, message=FALSE, warning=FALSE}

#run model for precipitation
bbs.absence <- glmer(BBS_Presence ~ #presence in BBS response
                        Rareness #rareness of appearance in BBA
                      + Proportion_Prec_NotSampled #proportion blocks outside BBS range
                      + (1|State), #random effect of state
                      data=ad.hoc2.analysis, #data
                      family=binomial) #binomial regression (Defaults to logit link)

#Output model
tab_model(bbs.absence,
          title="BBS Absence by Precipitation and Rareness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

#visualizing model
plot_model(bbs.absence,
           type="pred",
           terms="Rareness",
           se=T)+
  theme_classic()

#Visualizing random effect
plot_model(bbs.absence,type="pred",terms=c("Proportion_Prec_NotSampled","State"),
           show.data=T)+
  coord_flip()+
  theme_classic()+
  labs(title="Random Intercept Effect of State on BBS Absence
       Precipitation")

#Visualizing random effect on rareness
plot_model(bbs.absence,type="pred",terms=c("Rareness","State"),
           show.data=T)+
  theme_classic()+
  labs(title="Random Intercept Effect of State on BBS Absence
       Rareness")

#===

#run model for temperature
bbs.absence1 <- glmer(BBS_Presence ~ #presence in BBS response
                        Rareness #rareness of appearance in BBA
                      + Proportion_Temp_NotSampled #proportion blocks outside BBS range
                      + (1|State), #random effect of state
                      data=ad.hoc2.analysis, #data
                      family=binomial) #binomial regression (Defaults to logit link)

#Output model
tab_model(bbs.absence1,
          title="BBS Absence by Temperature and Rareness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

#Visualizing random effect
plot_model(bbs.absence1,type="pred",terms=c("Proportion_Temp_NotSampled","State"),
           show.data=T)+
  coord_flip()+
  theme_classic()+
  labs(title="Random Intercept Effect of State on BBS Absence
       Temperature")

#===

#Run model for both variables


#run model for temperature
bbs.absence2 <- glmer(BBS_Presence ~ #presence in BBS response
                        Rareness #rareness of appearance in BBA
                      + Proportion_Temp_NotSampled #proportion blocks outside BBS range
                      + Proportion_Prec_NotSampled
                      + (1|State), #random effect of state
                      data=ad.hoc2.analysis, #data
                      family=binomial) #binomial regression (Defaults to logit link)

#Output model
tab_model(bbs.absence2,
          title="BBS Absence by Climate and Rareness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

#visualizing
plot_model(bbs.absence2)+
  coord_flip()+
  theme_classic()

#Visualizing random effect
plot_model(bbs.absence2,type="re")+
  coord_flip()+
  theme_classic()

```





```{r Ad-hoc 2 removing items, message=FALSE, warning=FALSE}

rm(ad.hoc2.data2,ad.hoc2.analysis,
   ma.ad.hoc2,mi.ad.hoc2,ny.ad.hoc2,pa.ad.hoc2,vt.ad.hoc2,
   bbs.absence,bbs.absence1,
   ma.bbs.absence,ma.bbs.absence1,
   mi.bbs.absence,mi.bbs.absence1,
   ny.bbs.absence,ny.bbs.absence1,
   pa.bbs.absence,pa.bbs.absence1,
   vt.bbs.absence,vt.bbs.absence1)

```


---

#### Ad-hoc 3

**Higher local environmental heterogeneity will correlate with higher local species richness**

Running first a GLM with local richness as response variable, dataset and heterogeneity as fixed effects, and state as a random effect. 

Running three separate models for each of our heterogeneity metrics (elevation range, land-class richness, and land-class diversity).


**Starting with land-class richness**
```{r Ad-Hoc 3 Land-class richness model, message=FALSE, warning=FALSE}

#running model
assumption.landrich <- glmer(Atlas2_Total ~ Het_Count2006
                             + as.factor(Dataset)
                             + (1|State),
                             data=full_d,
                             family=poisson)

#output model
tab_model(assumption.landrich,
          title="Land Class Richness on Local Richness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()


```


*Plotting model*

```{r Ad-Hoc 3 LC Richness Plots, message=FALSE, warning=FALSE}


#R squared
r2.c=round(r.squaredGLMM(assumption.landrich)[1,2],digits=4) #with random effect
r2.m=round(r.squaredGLMM(assumption.landrich)[1,1],digits=4) #without
  
#Plotting model results (incidence ratios)
plot_model(assumption.landrich,
           show.values=T,
           show.p=T,
           show.intercept = T)+
    scale_color_brewer(type = "qual",palette = 7)+
  theme_classic()+ labs(title="Predicted Local Richness by Land-Class Richness")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_x_discrete(labels=c("Dataset (BBS)","Land-Class Richness","Intercept"))

#Without data points 
plot_model(assumption.landrich,type="pred",
           terms=c("Het_Count2006","Dataset"),
           pred.type="fe",
           show.data = F)+
  geom_line(size=1.5)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Local Richness by Land-Class Richness",
       x="Number of Land-Class Types",
       y="Local Bird Richness per Sampling Unit")+
   geom_label(aes(x=10,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black",
              label.size = NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,15))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,15,3))

#With points 
plot_model(assumption.landrich,type="pred",
           terms=c("Het_Count2006","Dataset"),
           pred.type="fe",
           show.data = T)+
  geom_line(size=1.5)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Local Richness by Land-Class Richness",
       x="Number of Land-Class Types",
       y="Local Bird Richness per Sampling Unit")+
   geom_label(aes(x=10,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black",
              label.size = NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,15))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,15,3))

#Plotting State random effect
plot_model(assumption.landrich,type="re",
           show.values=T,
           show.p=T)+
  theme_classic()+
  labs(title="Random Effect of State on Intercept")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_y_continuous(limits=c(0.5,1.5))

#Without data points for random effect
plot_model(assumption.landrich,type="pred",
           terms=c("Het_Count2006","State","Dataset"),
           pred.type="re",
           show.data = F)+
  geom_point(size=0.5)+
  geom_smooth(size=2)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 2)+
  labs(title="Predicted Local Richness by Land-Class Richness\nWith random effect of state",
       x="Number of Land-Class Types",
       y="Local Bird Richness per Sampling Unit")+
  theme(plot.title=element_text(hjust=0.5))+
   geom_label(aes(x=10,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black",
              label.size = NA)+
  coord_cartesian(ylim=c(0,130),xlim=c(0,15))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,15,3))


#With data points for random effect
plot_model(assumption.landrich,type="pred",
           terms=c("Het_Count2006","State","Dataset"),
           pred.type="re",
           show.data = T)+
  geom_point()+
  geom_smooth(size=2)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 2)+
  labs(title="Predicted Local Richness by Land-Class Richness\nWith random effect of state",
       x="Number of Land-Class Types",
       y="Local Bird Richness per Sampling Unit")+
  theme(plot.title=element_text(hjust=0.5))+
   geom_label(aes(x=10,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),
              col="black",
              label.size=NA)+
  coord_cartesian(ylim=c(0,130),xlim=c(0,15))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,15,3))
  
```


**Now Land-Class Diversity (shannon-wiener index)**
```{r Ad-Hoc 3 Land-class diversity model, message=FALSE, warning=FALSE}

#running model
assumption.landdiv <- glmer(Atlas2_Total ~ Shannon2006
                             + as.factor(Dataset)
                             + (1|State),
                             data=full_d,
                             family=poisson)

#output model
tab_model(assumption.landdiv,
          title="Land Class Diversity on Local Richness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()


```

*Plotting model*

```{r Ad-Hoc 3 LC Diversity Plots, message=FALSE, warning=FALSE}

#R squared
r2.c=round(r.squaredGLMM(assumption.landdiv)[1,2],digits=4) #with random effect
r2.m=round(r.squaredGLMM(assumption.landdiv)[1,1],digits=4) #without
  
#Plotting model results (incidence ratios)
plot_model(assumption.landdiv,
           show.values=T,
           show.p=T,
           show.intercept = T)+
    scale_color_brewer(type = "qual",palette = 7)+
  theme_classic()+ labs(title="Predicted Local Richness by Land-Class Diversity")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_x_discrete(labels=c("Dataset (BBS)","Land-Class Diversity","Intercept"))

#Without data points 
plot_model(assumption.landdiv,type="pred",
           terms=c("Shannon2006","Dataset"),
           pred.type="fe",
           show.data = F)+
  geom_line(size=1.5)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Local Richness by Land-Class Diversity",
       x="Land-Class Diversity",
       y="Local Bird Richness per Sampling Unit")+
   geom_label(aes(x=1.5,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black",
              label.size = NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,2.5))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,2.5,0.5))

#With points 
plot_model(assumption.landdiv,type="pred",
           terms=c("Shannon2006","Dataset"),
           pred.type="fe",
           show.data = T)+
  geom_line(size=1.5)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)+
  labs(title="Predicted Local Richness by Land-Class Diversity",
       x="Land-Class Diversity",
       y="Local Bird Richness per Sampling Unit")+
   geom_label(aes(x=1.5,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black",
              label.size = NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,2.5))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,2.5,0.5))

#Plotting State random effect
plot_model(assumption.landdiv,type="re",
           show.values=T,
           show.p=T)+
  theme_classic()+
  labs(title="Random Effect of State on Intercept")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_y_continuous(limits=c(0.5,1.5))

#Without data points for random effect
plot_model(assumption.landdiv,type="pred",
           terms=c("Shannon2006","State","Dataset"),
           pred.type="re",
           show.data = F)+
  geom_point(size=0.5)+
  geom_smooth(size=2)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 2)+
  labs(title="Predicted Local Richness by Land-Class Diversity\nWith random effect of state",
       x="Land-Class Diversity",
       y="Local Bird Richness per Sampling Unit")+
  theme(plot.title=element_text(hjust=0.5))+
   geom_label(aes(x=1.5,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),col="black",
              label.size = NA)+
  coord_cartesian(ylim=c(0,130),xlim=c(0,2.5))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,2.5,0.5))


#With data points for random effect
plot_model(assumption.landdiv,type="pred",
           terms=c("Shannon2006","State","Dataset"),
           pred.type="re",
           show.data = T)+
  geom_point()+
  geom_smooth(size=2)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 2)+
  labs(title="Predicted Local Richness by Land-Class Diversity\nWith random effect of state",
       x="Land-Class Diversity",
       y="Local Bird Richness per Sampling Unit")+
  theme(plot.title=element_text(hjust=0.5))+
   geom_label(aes(x=1.5,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),
              col="black",
              label.size=NA)+
  coord_cartesian(ylim=c(0,130),xlim=c(0,2.5))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,2.5,0.5))
  
```




**Now with elevation range**


```{r Ad-Hoc 3 Elevation Range model, message=FALSE, warning=FALSE}

#running model
assumption.elev <- glmer(Atlas2_Total ~ Elev_Range
                             + as.factor(Dataset)
                             + (1|State),
                             data=full_d,
                             family=poisson)

#output model
tab_model(assumption.elev,
        title="Elevation Range on Local Richness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()


```


*Plotting model*

```{r Ad-Hoc 3 Elevation Range Plots, message=FALSE, warning=FALSE}

#R squared
r2.c=round(r.squaredGLMM(assumption.elev)[1,2],digits=4) #with random effect
r2.m=round(r.squaredGLMM(assumption.elev)[1,1],digits=4) #without

#Plotting model results (incidence ratios)
plot_model(assumption.elev,
           show.values=T,
           show.p=T,
           show.intercept = T)+
  theme_classic()+ labs(title="Predicted Local Richness by Elevation Range")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_x_discrete(labels=c("Dataset (BBS)","Elevation Range","Intercept"))

#Without data points
plot_model(assumption.elev,type="pred", terms=c("Elev_Range","Dataset"),
           show.data = F)+
  theme_classic()+
  labs(title="Predicted Local Richness by Elevation Range",
       x="Elevation Range (m)",
       y="Local Bird Richness per Sampling Unit")+
  scale_color_brewer(type = "qual",palette = 7)+
  geom_label(aes(x=500,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),
              col="black",
              label.size=NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,1100))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,1100,250))


#With data points
plot_model(assumption.elev,type="pred", terms=c("Elev_Range","Dataset"),
           show.data = T)+
  theme_classic()+
  labs(title="Predicted Local Richness by Elevation Range",
       x="Elevation Range (m)",
       y="Local Bird Richness per Sampling Unit")+
      scale_color_brewer(type = "qual",palette = 7)+
   geom_label(aes(x=500,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),
              col="black",
              label.size=NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,1100))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,1100,250))

#Plotting State random effect
plot_model(assumption.elev,type="re",
           show.values=T,
           show.p=T)+
  theme_classic()+
  labs(title="Random Effect of State on Intercept")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_y_continuous(limits=c(0.5,1.5))

#Without data points for random effect
plot_model(assumption.elev,type="pred", terms=c("Elev_Range","State","Dataset"),
           pred.type = "re",
           show.data = F)+
  theme_classic()+
  geom_line(size=2)+
  labs(title="Predicted Local Richness by Elevation Range",
       x="Elevation Range (m)",
       y="Local Bird Richness per Sampling Unit")+
      scale_color_brewer(type = "qual",palette = 2)+
   geom_label(aes(x=500,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),
              col="black",
              label.size=NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,1100))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,1100,250))
  

#With data points for random effect
plot_model(assumption.elev,type="pred", 
           terms=c("Elev_Range","State","Dataset"),
           pred.type = "re",
           show.data = T)+
  theme_classic()+
  geom_line(size=2)+
  labs(title="Predicted Local Richness by Elevation Range",
       x="Elevation Range (m)",
       y="Local Bird Richness per Sampling Unit")+
      scale_color_brewer(type = "qual",palette = 2)+
   geom_label(aes(x=500,y=20,
                 label=paste("Marginal R2=",r2.m, 
                             "\nConditional R2=",r2.c)),
              col="black",
              label.size=NA)+
  theme(plot.title=element_text(hjust=0.5))+
  coord_cartesian(ylim=c(0,130),xlim=c(0,1100))+
  scale_y_continuous(breaks=seq(0,130,30))+
  scale_x_continuous(breaks=seq(0,1100,250))


```


**Now running a full GLM**

This has all heterogeneity metrics as well as mean elevation, mean annual rainfall, and mean summer temperature as potential predictors. Standardizing all continuous variables.
State as a random effect.

```{r Ad-Hoc 3 Full GLM Multivariate Model, message=FALSE, warning=FALSE}

#running model
assumption1.all <- glmer(Atlas2_Total ~ Dataset #Dataset
                       +scale(Precipitation)  #precipitation
                       +scale(Temp)  #summer temperature
                       +scale(Elev_Mean)  #elevation mean in block/route
                       +scale(Elev_Range)  #elevation range in block/route
                       +scale(Het_Count2006)  # land-class richness
                       +scale(Shannon2006) # land-class diversity (Shannon-Wiener index)
                       +(1|State), #state as random effect
                       data=full_d, # data
                     family=poisson)

#output model
tab_model(assumption1.all,
        title="Full GLM on Local Richness",
          string.pred = "Coefficient",
          string.ci = "95% CIs",
          string.p = "P-Value",
          show.se = T,
          string.se="SE") %>%
  return() %$% 
    knitr %>% 
    asis_output()

```



*Plotting model results*

```{r Ad-Hoc 3 Full GLM Plots, message=FALSE, warning=FALSE}

#plotting coefficient plot
plot_model(assumption1.all,
           show.values = T,
           show.p=T,
           sort.est=T)+theme_classic()+
  labs(title="Predicted Local Richness GLM")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_x_discrete(labels=c("Elevation Mean",
                            "Land-Class Diversity",
                            "Summer Temperature",
                            "Land-Class Richness",
                            "Elevation Range",
                            "Precipitation",
                            "Dataset"
                            ))

#Plotting State random effect
plot_model(assumption1.all,type="re",
           show.values=T,
           show.p=T)+
  theme_classic()+
  labs(title="Random Effect of State on Intercept full GLM")+
  theme(plot.title=element_text(hjust=0.5))+
  geom_hline(yintercept = 1,linetype="dotted")+
  scale_y_continuous(limits=c(0.5,1.5))



```



*Individual Effects*
```{r Ad-Hoc 3 full GLM individual effects, message=FALSE, warning=FALSE}

#Just Dataset
plot_model(assumption1.all,
           type="pred",terms="Dataset",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)
  
#with random effect of state
plot_model(assumption1.all,
           type="pred",terms=c("State","Dataset"),
           pred.type="re",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)

#Precipitation
plot_model(assumption1.all,
           type="pred",terms="Precipitation",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)

#Temperature
plot_model(assumption1.all,
           type="pred",terms="Temp",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)


#Elevation
plot_model(assumption1.all,
           type="pred",terms="Elev_Mean",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)

#Elevation Range
plot_model(assumption1.all,
           type="pred",terms="Elev_Range",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)


#Land-Class Richness
plot_model(assumption1.all,
           type="pred",terms="Het_Count2006",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)


#Land-Class Diversity
plot_model(assumption1.all,
           type="pred",terms="Shannon2006",
           pred.type="fe",
           show.data = F)+
  theme_classic()+
  scale_color_brewer(type = "qual",palette = 7)
  
```



---

#### Ad-hoc 4

**Geographic matching of pairs of BBA and BBS sampling units based on largest overlap (thereby controlling for sample size and geography) will still show higher compositional turnover for BBA blocks**

We test this by running a Jaccard distance and doing a permutation difference of mean test as well as a betadisper test as in Main Prediction 7, but on matched sampling units.

We then also test whether environmental conditions are more similar across BBS sampling units than BBA.

We test this by running a Bray-Curtis similarity for each variable and compare BBA to BBS for each state and entire region.

We also run a Gower multivariate similarity to test all variables together.

**Starting with Jaccard test of compositional turnover**

```{r Ad-Hoc 4 Jaccard Datasets, message=FALSE, warning=FALSE}

species <- c(14:291)

#jaccard matrix for BBS
bs=Matched %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
bs <- as.vector(bs)
#Now making a dataset column
bs<- as.data.frame(bs)
bs$Dataset <- "BBS"
colnames(bs) <- c("Jaccard","Dataset")

#Now for BBA
ba=Matched %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
ba <- as.vector(ba)
#Now making a dataset column
ba<- as.data.frame(ba)
ba$Dataset <- "BBA"
colnames(ba) <- c("Jaccard","Dataset")


#Now MA

mabs=Matched %>%
  filter(Dataset=="BBS",
         State=="MA") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
mabs <- as.vector(mabs)
#Now making a dataset column
mabs<- as.data.frame(mabs)
mabs$Dataset <- "BBS"
colnames(mabs) <- c("Jaccard","Dataset")

maba=Matched %>%
  filter(Dataset=="BBA",
         State=="MA") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
maba <- as.vector(maba)
#Now making a dataset column
maba<- as.data.frame(maba)
maba$Dataset <- "BBA"
colnames(maba) <- c("Jaccard","Dataset")


#Now MI

mibs=Matched %>%
  filter(Dataset=="BBS",
         State=="MI") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
mibs <- as.vector(mibs)
#Now making a dataset column
mibs<- as.data.frame(mibs)
mibs$Dataset <- "BBS"
colnames(mibs) <- c("Jaccard","Dataset")

miba=Matched %>%
  filter(Dataset=="BBA",
         State=="MI") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
miba <- as.vector(miba)
#Now making a dataset column
miba<- as.data.frame(miba)
miba$Dataset <- "BBA"
colnames(miba) <- c("Jaccard","Dataset")


#Now NY

nybs=Matched %>%
  filter(Dataset=="BBS",
         State=="NY") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
nybs <- as.vector(nybs)
#Now making a dataset column
nybs<- as.data.frame(nybs)
nybs$Dataset <- "BBS"
colnames(nybs) <- c("Jaccard","Dataset")

nyba=Matched %>%
  filter(Dataset=="BBA",
         State=="NY") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
nyba <- as.vector(nyba)
#Now making a dataset column
nyba<- as.data.frame(nyba)
nyba$Dataset <- "BBA"
colnames(nyba) <- c("Jaccard","Dataset")


#Now PA

pabs=Matched %>%
  filter(Dataset=="BBS",
         State=="PA") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
pabs <- as.vector(pabs)
#Now making a dataset column
pabs<- as.data.frame(pabs)
pabs$Dataset <- "BBS"
colnames(pabs) <- c("Jaccard","Dataset")

paba=Matched %>%
  filter(Dataset=="BBA",
         State=="PA") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
paba <- as.vector(paba)
#Now making a dataset column
paba<- as.data.frame(paba)
paba$Dataset <- "BBA"
colnames(paba) <- c("Jaccard","Dataset")


#Now VT

vtbs=Matched %>%
  filter(Dataset=="BBS",
         State=="VT") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
vtbs <- as.vector(vtbs)
#Now making a dataset column
vtbs<- as.data.frame(vtbs)
vtbs$Dataset <- "BBS"
colnames(vtbs) <- c("Jaccard","Dataset")

vtba=Matched %>%
  filter(Dataset=="BBA",
         State=="VT") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
vtba <- as.vector(vtba)
#Now making a dataset column
vtba<- as.data.frame(vtba)
vtba$Dataset <- "BBA"
colnames(vtba) <- c("Jaccard","Dataset")


#== Now for sampled adjacent blocks and not matched

#jaccard matrix for BBS
bs2=SampledAdj_Full %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
bs2 <- as.vector(bs2)
#Now making a dataset column
bs2<- as.data.frame(bs2)
bs2$Dataset <- "BBS"
colnames(bs2) <- c("Jaccard","Dataset")

#Now for BBA
ba2=SampledAdj_Full %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(species) %>%
  vegdist(.,method="jaccard",binary=T)
#turning to vector
ba2 <- as.vector(ba2)
#Now making a dataset column
ba2<- as.data.frame(ba2)
ba2$Dataset <- "BBA"
colnames(ba2) <- c("Jaccard","Dataset")

```


**Running permutation two-tailed t test**

Running a permutation t-test using perm.t.test from the GmAMisc package, with 1000 permutations.
This will see if BBA or BBS are more or less dissimilar internally in terms of species composition (using the Jaccard Index as a measure of distance between two sites).


*Starting with entire dataset:*

```{r Ad-Hoc 4 Regional Permutation Jaccard Test, message=F,warning=FALSE}
#Running permutation test that takes as arguments the dataframe we just created, 
#the format is short (meaning there are two columns, one for each dataset).
#Then labeling each variable we're comparing, and saying run 1000 permutations

region.perm.test <- list(bs,ba)
region.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),region.perm.test, accumulate=FALSE)

perm.t.test(region.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(ba,bs,region.perm.test)

#now test on sampled adjacent
region.perm.test2 <- list(bs2,ba2)
region.perm.test2 <- Reduce(function(x,y) merge(x,y,all=TRUE),region.perm.test2, accumulate=FALSE)

perm.t.test(region.perm.test2,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(ba2,bs2,region.perm.test2)

```


**Now running for every state**

*MA*

```{r Ad-Hoc 4 MA Permutation Test, message=F, warning=F}
#MA
ma.perm.test <- list(mabs,maba)
ma.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),ma.perm.test, accumulate=FALSE)

perm.t.test(ma.perm.test,
           format = "long",
            sample1.lab = "MABBA",
            sample2.lab = "MABBS",
            B=1000)

#removing from environment to save space
rm(maba,mabs,ma.perm.test)
```


*MI*
```{r Ad-Hoc 4 MI Permutation Test, message=FALSE, warning=FALSE}
#MI
mi.perm.test <- list(mibs,miba)
mi.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),mi.perm.test, accumulate=FALSE)

perm.t.test(mi.perm.test,
            format = "long",
            sample1.lab = "MIBBA",
            sample2.lab = "MIBBS",
            B=1000)

#removing from environment to save space
rm(miba,mibs,mi.perm.test)
```


*NY*
```{r Ad-Hoc 4 NY Permutation Test, message=FALSE, warning=FALSE}
#NY
ny.perm.test <- list(nybs,nyba)
ny.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),ny.perm.test, accumulate=FALSE)

perm.t.test(ny.perm.test,
            format = "long",
            sample1.lab = "NYBBA",
            sample2.lab = "NYBBS",
            B=1000)

#removing from environment to save space
rm(nyba,nybs,ny.perm.test)
```


*PA*
```{r Ad-Hoc 4 PA Permutation Test, message=FALSE, warning=FALSE}
#PA
pa.perm.test <- list(pabs,paba)
pa.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),pa.perm.test, accumulate=FALSE)

perm.t.test(pa.perm.test,
            format = "long",
            sample1.lab = "PABBA",
            sample2.lab = "PABBS",
            B=1000)

#removing from environment to save space
rm(paba,pabs,pa.perm.test)
```


*VT*
```{r Ad-Hoc 4 VT Permutation Test, message=FALSE, warning=FALSE}
vt.perm.test <- list(vtbs,vtba)
vt.perm.test <- Reduce(function(x,y) merge(x,y,all=TRUE),vt.perm.test, accumulate=FALSE)

perm.t.test(vt.perm.test,
            format = "long",
            sample1.lab = "VTBBA",
            sample2.lab = "VTBBS",
            B=1000)

#removing from environment to save space
rm(vtba,vtbs,vt.perm.test)
```

---

##### Running Ordinal Test for Ad-Hoc 4

Now we will do a similar test to check differences in species composition between BBA and BBS using Jaccard as our distance. 
However, this time we'll run a nonmetric multidimensional ordination analysis (NMDS) using the vegan package. 
Then we'll run a distance-based test for homogeneity of multivariate dispersion also using betadisper in vegan.

**Setting up Ordination**
```{r Ad-Hoc 4 Ordination,message=FALSE, warning=FALSE}

#Subsetting predictor variables and then species matrix from full data
ordination.ad.hoc4 <- Matched[c(2:3,14:291)]

#running jaccard distance calclation
ordination.dist = vegdist(ordination.ad.hoc4[3:283], 
                          method = "jaccard", 
                          binary = T)

#predictor variables
ordination.pred <- ordination.ad.hoc4[1:2]

```


**Outputting Results**
```{r Ad-Hoc 4 Ordination Results}
#running distance-based test for homogeneity of multivariate dispersion 
ad.hoc4 <- betadisper(ordination.dist,
                          group=ordination.pred$Dataset,
                          type="centroid")

#summary of test
ad.hoc4

#ANOVA
anova(ad.hoc4)

#TukeyHSD significance test
TukeyHSD(ad.hoc4)

#saving object since it's so painstaking to run
save(ad.hoc4, file="Ad-Hoc 4 Ordination.RData")

```


**Plotting Results**
```{r Ad-Hoc 4 Ordination Plots, message=FALSE, warning=FALSE}
#boxplot
boxplot(ad.hoc4, 
        main="Ad-Hoc 4 - Homogeneity of Multivariate Dispersion",
        xlab="Dataset",
        ylab="Distance to Centroid",
        notch=F, col=c("#66C2A5","#FC8D62"))


#ordination plot

#calculating ordination % variance explained
labs <- paste("Dimension", "(", 
              round(100*ad.hoc4$eig / sum(ad.hoc4$eig), 2), "%)")


# #plotting
# myplotbetadisper(ad.hoc4,pch=1:2,
#      col=scales::alpha(c("#66C2A5","#FC8D62"),1),
#      hull=T,lwd=2,
#      seg.col=scales::alpha("grey",0.05),
#      label=F,
#      alphaPoints=1,
#      main="Ad-Hoc 4 - Homogeneity of Multivariate Dispersion", 
#      xlab=labs[1], ylab=labs[2],
#      cex.lab=1.25
#      )

#remove from environment
rm(ordination.pred,ordination.dist,ordination.ad.hoc4)
```


**Now doing it for sampled adjacent blocks and not matched**

**Setting up Ordination**
```{r Ad-Hoc 4 Ordination SampledAdj,message=FALSE, warning=FALSE}

#Subsetting predictor variables and then species matrix from full data
ordination.ad.hoc4 <- SampledAdj_Full[c(2:3,14:291)]

#running jaccard distance calclation
ordination.dist = vegdist(ordination.ad.hoc4[3:280], 
                          method = "jaccard", 
                          binary = T)

#predictor variables
ordination.pred <- ordination.ad.hoc4[1:2]

```


**Outputting Results**
```{r Ad-Hoc 4 Ordination SampledAdj Results}
#running distance-based test for homogeneity of multivariate dispersion 
ad.hoc4 <- betadisper(ordination.dist,
                          group=ordination.pred$Dataset,
                          type="centroid")

#summary of test
ad.hoc4

#ANOVA
anova(ad.hoc4)

#TukeyHSD significance test
TukeyHSD(ad.hoc4)

#saving object since it's so painstaking to run
save(ad.hoc4, file="Ad-Hoc 4 Ordination.RData")

```


**Plotting Results**
```{r Ad-Hoc 4 Ordination SampledAdj Plots, message=FALSE, warning=FALSE}
#boxplot
boxplot(ad.hoc4, 
        main="Ad-Hoc 4 - Homogeneity of Multivariate Dispersion (SampledAdj)",
        xlab="Dataset",
        ylab="Distance to Centroid",
        notch=F, col=c("#66C2A5","#FC8D62"))


#ordination plot

#calculating ordination % variance explained
labs <- paste("Dimension", "(", 
              round(100*ad.hoc4$eig / sum(ad.hoc4$eig), 2), "%)")


# #plotting
# myplotbetadisper(ad.hoc4,pch=c(16,16),
#      col=scales::alpha(c("#66C2A5","#FC8D62"),1),
#      hull=T,lwd=2,
#      seg.col=scales::alpha("grey",0.05),
#      label=F,
#      alphaPoints=1,
#      main="Ad-Hoc 4 - Homogeneity of Multivariate Dispersion (SampledAdj)", 
#      xlab=labs[1], ylab=labs[2],
#      cex.lab=1.25
#      )

#remove from environment
rm(ordination.pred,ordination.dist,ordination.ad.hoc4)
```

---

##### Similarities in Environmental Conditions



```{r Ad-Hoc 4 Bray-Curtis and Gower Datasets, message=FALSE, warning=FALSE}

#BBS Bray Elevation
ele.bs.bray=Matched %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(Elev_Mean) %>%
  vegdist(.,method="bray",na.rm=T)

ele.bs.bray <- as.vector(ele.bs.bray)
ele.bs.bray <- 1-ele.bs.bray #similarity
ele.bs.bray <- as.data.frame(ele.bs.bray)
colnames(ele.bs.bray) <- "Elevation_Bray"
ele.bs.bray$Data <- "BBS"

#BBS Bray Precipitation
prec.bs.bray=Matched %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(Precipitation) %>%
  vegdist(.,method="bray",na.rm=T)

prec.bs.bray <- as.vector(prec.bs.bray)
prec.bs.bray <- 1-prec.bs.bray #similarity
prec.bs.bray <- as.data.frame(prec.bs.bray)
colnames(prec.bs.bray) <- "Precipitation_Bray"
prec.bs.bray$Data <- "BBS"

#BBS Bray Temperature
temp.bs.bray=Matched %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(Temp) %>%
  vegdist(.,method="bray",na.rm=T)

temp.bs.bray <- as.vector(temp.bs.bray)
temp.bs.bray <- 1-temp.bs.bray #similarity
temp.bs.bray <- as.data.frame(temp.bs.bray)
colnames(temp.bs.bray) <- "Temp_Bray"
temp.bs.bray$Data <- "BBS"

#BBS Land-Cover Composition
land <-c(321:335)
land.bs.bray=Matched %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(land) %>%
  vegdist(.,method="bray",na.rm=T)

land.bs.bray <- as.vector(land.bs.bray)
land.bs.bray <- 1-land.bs.bray #similarity
land.bs.bray <- as.data.frame(land.bs.bray)
colnames(land.bs.bray) <- "Land_Bray"
land.bs.bray$Data <- "BBS"

#BBS Gower Multivariate Distance
BBS.Gower <- Matched %>%
  filter(Dataset=="BBS") %>%
  dplyr::select(Shannon2006,Elev_Mean,Precipitation,Temp)

bs.gower=vegdist(BBS.Gower,method="gower",na.rm=T)
bs.gower <- as.vector(bs.gower)
bs.gower<- as.data.frame(bs.gower)
colnames(bs.gower) <- "Gower"
bs.gower$Data <- "BBS"


############

#BBA Bray Elevation
ele.ba.bray=Matched %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(Elev_Mean) %>%
  vegdist(.,method="bray",na.rm=T)

ele.ba.bray <- as.vector(ele.ba.bray)
ele.ba.bray <- 1-ele.ba.bray #similarity
ele.ba.bray <- as.data.frame(ele.ba.bray)
colnames(ele.ba.bray) <- "Elevation_Bray"
ele.ba.bray$Data <- "BBA"

#BBA Bray Precipitation
prec.ba.bray=Matched %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(Precipitation) %>%
  vegdist(.,method="bray",na.rm=T)

prec.ba.bray <- as.vector(prec.ba.bray)
prec.ba.bray <- 1-prec.ba.bray #similarity
prec.ba.bray <- as.data.frame(prec.ba.bray)
colnames(prec.ba.bray) <- "Precipitation_Bray"
prec.ba.bray$Data <- "BBA"

#BBA Bray Temperature
temp.ba.bray=Matched %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(Temp) %>%
  vegdist(.,method="bray",na.rm=T)

temp.ba.bray <- as.vector(temp.ba.bray)
temp.ba.bray <- 1-temp.ba.bray #similarity
temp.ba.bray <- as.data.frame(temp.ba.bray)
colnames(temp.ba.bray) <- "Temp_Bray"
temp.ba.bray$Data <- "BBA"

#BBA Land-Cover Composition
land.ba.bray=Matched %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(land) %>%
  vegdist(.,method="bray",na.rm=T)

land.ba.bray <- as.vector(land.ba.bray)
land.ba.bray <- 1-land.ba.bray #similarity
land.ba.bray <- as.data.frame(land.ba.bray)
land.ba.bray <- na.omit(land.ba.bray)
colnames(land.ba.bray) <- "Land_Bray"
land.ba.bray$Data <- "BBA"

#BBA Gower Multivariate Distance
BBA.Gower <- Matched %>%
  filter(Dataset=="BBA") %>%
  dplyr::select(Shannon2006,Elev_Mean,Precipitation,Temp) %>%
  na.omit(.)

ba.gower=vegdist(BBA.Gower,method="gower",na.rm=T)
ba.gower <- as.vector(ba.gower)
ba.gower<- as.data.frame(ba.gower)
colnames(ba.gower) <- "Gower"
ba.gower$Data <- "BBA"


```


**Permutation Tests**

Starting with Elevation

```{r Ad-Hoc 4 Permutation Tests Elevation, message=FALSE, warning=FALSE}
#combining data
ele.perm.test <- rbind.data.frame(ele.bs.bray,ele.ba.bray)

#Creating permutation randomly sampling difference between means
perm.t.test(ele.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(ele.perm.test,ele.bs.bray,ele.ba.bray)

```

Precipitation

```{r Ad-Hoc 4 Permutation Tests Precipitation, message=FALSE, warning=FALSE}

#combining data
prec.perm.test <- rbind.data.frame(prec.bs.bray,prec.ba.bray)

#Creating permutation randomly sampling difference between means
perm.t.test(prec.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(prec.perm.test,prec.bs.bray,prec.ba.bray)

```


Temperature

```{r Ad-Hoc 4 Permutation Tests Temperature, message=FALSE, warning=FALSE}

#combining data
temp.perm.test <- rbind.data.frame(temp.bs.bray,temp.ba.bray)

#Creating permutation randomly sampling difference between means
perm.t.test(temp.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(temp.perm.test,temp.bs.bray,temp.ba.bray)

```


Land-Cover Composition

```{r Ad-Hoc 4 Permutation Tests Land-Cover, message=FALSE, warning=FALSE}

#combining data
land.perm.test <- rbind.data.frame(land.bs.bray,land.ba.bray)

#Creating permutation randomly sampling difference between means
perm.t.test(land.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(land.perm.test,land.bs.bray,land.ba.bray)


```


Now multivariate difference in all environmental factors using Gower

```{r Assumption 4 Permutation Tests Gower, message=FALSE, warning=FALSE}

#combining data
gower.perm.test <- rbind.data.frame(bs.gower,ba.gower)

#Creating permutation randomly sampling difference between means
perm.t.test(gower.perm.test,
            format = "long",
            sample1.lab = "BBA",
            sample2.lab = "BBS",
            B=1000)

#removing from environment
rm(gower.perm.test,bs.gower,ba.gower)

```






---

#### Ad-hoc 5

**BBA and BBS sample different environmental conditions due to geography**  

Going to test whether the datasets sample different environmental conditions in terms of the distribution of each environmental variable.  
    + Testing differences in precipitation, temperature, and mean elevation using a Kolmogorov-Smirnov test with the ks.test() function from the dgof package.  
    + Then will run a PERMANOVA testing whether land-cover composition (shannon-wiener index) differs between BBA sites more so than between BBA sites using Bray-Curtis index (as in Ad-hoc test 4).  
    + Will run this the whole dataset and also for each state  


**Starting with Kolmogorov-Smirnov tests on Elevation**

```{r Ad-Hoc 5 K.S. Elevation tests, message=FALSE, warning=FALSE}

##Entire dataset
ks.test(BBA$Elev_Mean,BBS$Elev_Mean)

#MA
ks.test(MABBA$Elev_Mean,MABBS$Elev_Mean)

#MI
ks.test(MIBBA$Elev_Mean,MIBBS$Elev_Mean)

#NY
ks.test(NYBBA$Elev_Mean,NYBBS$Elev_Mean)

#PA
ks.test(PABBA$Elev_Mean,PABBS$Elev_Mean)

#VT
ks.test(VTBBA$Elev_Mean,VTBBS$Elev_Mean)


##

##Adjacent
ks.test(Adj$Elev_Mean,BBS$Elev_Mean)

#MA
ks.test(MA_BBA_Adj$Elev_Mean,MABBS$Elev_Mean)

#MI
ks.test(MI_BBA_Adj$Elev_Mean,MIBBS$Elev_Mean)

#NY
ks.test(NY_BBA_Adj$Elev_Mean,NYBBS$Elev_Mean)

#PA
ks.test(PA_BBA_Adj$Elev_Mean,PABBS$Elev_Mean)

#VT
ks.test(VT_BBA_Adj$Elev_Mean,VTBBS$Elev_Mean)

```

*ONLY Non-adjacent BBA blocks in VT are significantly different in elevation than BBS routes in VT*

Now for Precipitation

```{r Ad-Hoc 5 K.S. Precipitation tests, message=FALSE, warning=FALSE}

##Entire dataset
ks.test(BBA$Precipitation,BBS$Precipitation)

#MA
ks.test(MABBA$Precipitation,MABBS$Precipitation)

#MI
ks.test(MIBBA$Precipitation,MIBBS$Precipitation)

#NY
ks.test(NYBBA$Precipitation,NYBBS$Precipitation)

#PA
ks.test(PABBA$Precipitation,PABBS$Precipitation)

#VT
ks.test(VTBBA$Precipitation,VTBBS$Precipitation)


##

##Adjacent
ks.test(Adj$Precipitation,BBS$Precipitation)

#MA
ks.test(MA_BBA_Adj$Precipitation,MABBS$Precipitation)

#MI
ks.test(MI_BBA_Adj$Precipitation,MIBBS$Precipitation)

#NY
ks.test(NY_BBA_Adj$Precipitation,NYBBS$Precipitation)

#PA
ks.test(PA_BBA_Adj$Precipitation,PABBS$Precipitation)

#VT
ks.test(VT_BBA_Adj$Precipitation,VTBBS$Precipitation)

```



Now for Temperature

```{r Ad-Hoc 5 K.S. Temp tests, message=FALSE, warning=FALSE}

##Entire dataset
ks.test(BBA$Temp,BBS$Temp)

#MA
ks.test(MABBA$Temp,MABBS$Temp)

#MI
ks.test(MIBBA$Temp,MIBBS$Temp)

#NY
ks.test(NYBBA$Temp,NYBBS$Temp)

#PA
ks.test(PABBA$Temp,PABBS$Temp)

#VT
ks.test(VTBBA$Temp,VTBBS$Temp)


##

##Adjacent
ks.test(Adj$Temp,BBS$Temp)

#MA
ks.test(MA_BBA_Adj$Temp,MABBS$Temp)

#MI
ks.test(MI_BBA_Adj$Temp,MIBBS$Temp)

#NY
ks.test(NY_BBA_Adj$Temp,NYBBS$Temp)

#PA
ks.test(PA_BBA_Adj$Temp,PABBS$Temp)

#VT
ks.test(VT_BBA_Adj$Temp,VTBBS$Temp)

```



Now running PERMANOVA on Bray-Curtis similarity for land-cover composition

```{r Ad-Hoc 5 PERMANOVA Land-Cover, message=FALSE, warning=FALSE}

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data <- full_d[c(2,335)]

#removing NAs and zeros
ad.hoc5.data <- ad.hoc5.data %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred <- ad.hoc5.data[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist=vegdist(ad.hoc5.data[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.region<- adonis(ad.hoc5.dist ~ Dataset,data=ad.hoc5.pred,permutations=100,method="bray")

#Region Output
ad.hoc5.region

####

#MA

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.ma <- MA[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.ma <- ad.hoc5.data.ma %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.ma <- ad.hoc5.data.ma[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.ma=vegdist(ad.hoc5.data.ma[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.ma<- adonis(ad.hoc5.dist.ma ~ Dataset,data=ad.hoc5.pred.ma,permutations=100,method="bray")

#MA Output
ad.hoc5.ma

####

#MI

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.mi <- MI[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.mi <- ad.hoc5.data.mi %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.mi <- ad.hoc5.data.mi[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.mi=vegdist(ad.hoc5.data.mi[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.mi<- adonis(ad.hoc5.dist.mi ~ Dataset,data=ad.hoc5.pred.mi,permutations=100,method="bray")

#MI Output
ad.hoc5.mi

####

#NY

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.ny <- NY[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.ny <- ad.hoc5.data.ny %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.ny <- ad.hoc5.data.ny[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.ny=vegdist(ad.hoc5.data.ny[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.ny<- adonis(ad.hoc5.dist.ny ~ Dataset,data=ad.hoc5.pred.ny,permutations=100,method="bray")

#NY Output
ad.hoc5.ny

####

#PA

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.pa <- PA[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.pa <- ad.hoc5.data.pa %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.pa <- ad.hoc5.data.pa[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.pa=vegdist(ad.hoc5.data.pa[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.pa<- adonis(ad.hoc5.dist.pa ~ Dataset,data=ad.hoc5.pred.pa,permutations=100,method="bray")

#PA Output
ad.hoc5.pa

####

#VT

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.vt <- VT[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.vt <- ad.hoc5.data.vt %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.vt <- ad.hoc5.data.vt[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.vt=vegdist(ad.hoc5.data.vt[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.vt<- adonis(ad.hoc5.dist.vt ~ Dataset,data=ad.hoc5.pred.vt,permutations=100,method="bray")

#VT Output
ad.hoc5.vt


#removing from environment
rm(ad.hoc5.data,
   ad.hoc5.data.ma,
   ad.hoc5.data.mi,
   ad.hoc5.data.ny,
   ad.hoc5.data.pa,
   ad.hoc5.data.vt,
   ad.hoc5.dist,
   ad.hoc5.dist.ma,
   ad.hoc5.dist.mi,
   ad.hoc5.dist.mi,
   ad.hoc5.dist.ny,
   ad.hoc5.dist.pa,
   ad.hoc5.dist.pa,
   ad.hoc5.dist.vt,
   ad.hoc5.region,
   ad.hoc5.ma,
   ad.hoc5.mi,
   ad.hoc5.ny,
   ad.hoc5.pa,
   ad.hoc5.vt,
   ad.hoc5.pred.ma,
   ad.hoc5.pred.mi,
   ad.hoc5.pred.ny,
   ad.hoc5.pred.pa,
   ad.hoc5.pred.vt)

```


Now for adjacent blocks

```{r Ad-Hoc 5 PERMANOVA Land-Cover Adjacent, message=FALSE, warning=FALSE}

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.adj <- Adjacent_Full[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.adj <- ad.hoc5.data.adj %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.adj <- ad.hoc5.data.adj[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.adj=vegdist(ad.hoc5.data.adj[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.adj<- adonis(ad.hoc5.dist.adj ~ Dataset,data=ad.hoc5.pred.adj,permutations=100,method="bray")

#Adjacent Output
ad.hoc5.adj

####

#MA

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.ma.adj <- MAAdj[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.ma.adj <- ad.hoc5.data.ma.adj %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.ma.adj <- ad.hoc5.data.ma.adj[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.ma.adj=vegdist(ad.hoc5.data.ma.adj[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.ma.adj<- adonis(ad.hoc5.dist.ma.adj ~ Dataset,data=ad.hoc5.pred.ma.adj,permutations=100,method="bray")

#MA Output
ad.hoc5.ma.adj

####

#MI

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.mi.adj <- MIAdj[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.mi.adj <- ad.hoc5.data.mi.adj %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.mi.adj <- ad.hoc5.data.mi.adj[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.mi.adj=vegdist(ad.hoc5.data.mi.adj[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.mi.adj<- adonis(ad.hoc5.dist.mi.adj ~ Dataset,data=ad.hoc5.pred.mi.adj,permutations=100,method="bray")

#MI Output
ad.hoc5.mi.adj

####

#NY

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.ny.adj <- NYAdj[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.ny.adj <- ad.hoc5.data.ny.adj %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.ny.adj <- ad.hoc5.data.ny.adj[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.ny.adj=vegdist(ad.hoc5.data.ny.adj[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.ny.adj<- adonis(ad.hoc5.dist.ny.adj ~ Dataset,data=ad.hoc5.pred.ny.adj,permutations=100,method="bray")

#NY Output
ad.hoc5.ny.adj


####

#PA

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.pa.adj <- PAAdj[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.pa.adj <- ad.hoc5.data.pa.adj %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.pa.adj <- ad.hoc5.data.pa.adj[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.pa.adj=vegdist(ad.hoc5.data.pa.adj[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.pa.adj<- adonis(ad.hoc5.dist.pa.adj ~ Dataset,data=ad.hoc5.pred.pa.adj,permutations=100,method="bray")

#PA Output
ad.hoc5.pa.adj


####

#VT

#subsetting predictor variables (dataset) and shannon-wiener index of land-cover composition
ad.hoc5.data.vt.adj <- VTAdj[c(2,335)]

#removing NAs and zeros
ad.hoc5.data.vt.adj <- ad.hoc5.data.vt.adj %>%
  filter(!is.na(Shannon2006),Shannon2006!=0)

#subsetting predictor data
ad.hoc5.pred.vt.adj <- ad.hoc5.data.vt.adj[1]

#creating distance object using bray-curtis for PERMANOVA analysis
ad.hoc5.dist.vt.adj=vegdist(ad.hoc5.data.vt.adj[2],method="bray",na.rm=T)

#Running PERMANOVA using adonis() function
ad.hoc5.vt.adj<- adonis(ad.hoc5.dist.vt.adj ~ Dataset,data=ad.hoc5.pred.vt.adj,permutations=100,method="bray")

#VT Output
ad.hoc5.vt.adj


#removing from environment
rm(ad.hoc5.data.adj,
   ad.hoc5.data.ma.adj,
   ad.hoc5.data.mi.adj,
   ad.hoc5.data.ny.adj,
   ad.hoc5.data.pa.adj,
   ad.hoc5.data.vt.adj,
   ad.hoc5.dist.adj,
   ad.hoc5.dist.ma.adj,
   ad.hoc5.dist.mi.adj,
   ad.hoc5.dist.mi.adj,
   ad.hoc5.dist.ny.adj,
   ad.hoc5.dist.pa.adj,
   ad.hoc5.dist.pa.adj,
   ad.hoc5.dist.vt.adj,
   ad.hoc5.region.adj,
   ad.hoc5.ma.adj,
   ad.hoc5.mi.adj,
   ad.hoc5.ny.adj,
   ad.hoc5.pa.adj,
   ad.hoc5.vt.adj,
   ad.hoc5.pred.ma.adj,
   ad.hoc5.pred.mi.adj,
   ad.hoc5.pred.ny.adj,
   ad.hoc5.pred.pa.adj,
   ad.hoc5.pred.vt.adj)

```



#Saving workspace

```{r save workspace,message=FALSE, warning=FALSE}

save.image(file="BirdAnalysesFinal.RData")

```

